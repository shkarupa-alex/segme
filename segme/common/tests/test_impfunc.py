import numpy as np
import tensorflow as tf

from segme.common.impfunc import grid_sample
from segme.common.impfunc import make_coords
from segme.common.impfunc import query_features


class TestGridSample(tf.test.TestCase):

    features = [  # 2 x 3 x 8 x 2
        [
            [
                [0.5803560530488882, 0.9758733582668992],
                [0.3060797016509539, 0.8958330296139824],
                [0.04392514449205642, 0.6417255796191343],
                [0.05154120577339916, 0.5912343257885164],
                [0.4269209266455476, 0.47205654127613983],
                [0.4866003048338161, 0.8279622963285193],
                [0.6993539913503232, 0.37485069691849404],
                [0.10575711773669993, 0.9825946582539481],
            ],
            [
                [0.8257234224540615, 0.5206645988316856],
                [0.7093410631788002, 0.1437249653745346],
                [0.17192861245295066, 0.7740607221316901],
                [0.8234077712492931, 0.3505931790314334],
                [0.8162857557989622, 0.27297732800530183],
                [0.9250948423285806, 0.29757936684731723],
                [0.6986999087019943, 0.3079055707545305],
                [0.21179192038896555, 0.3171553461301925],
            ],
            [
                [0.9843725970754822, 0.9813871174443999],
                [0.44842257348612125, 0.130380716609253],
                [0.7722375422750853, 0.10364272271858943],
                [0.4393488700955268, 0.4548532986245398],
                [0.47505635832467275, 0.37804489426244103],
                [0.8258436454865106, 0.35831259847880437],
                [0.8239819761272512, 0.8828993842018817],
                [0.49231643099716704, 0.23657644268638445],
            ],
        ],
        [
            [
                [0.3470358737217457, 0.16735936338606427],
                [0.9517472467867465, 0.9799591409158379],
                [0.35939672961575697, 0.5674854226639825],
                [0.7903688431119552, 0.8681517646006246],
                [0.19527231727607397, 0.6249876602109309],
                [0.6353167539043052, 0.1460755017217389],
                [0.6647652592142212, 0.8747084010404066],
                [0.5379436958925545, 0.06270574106266635],
            ],
            [
                [0.05861333972611882, 0.532425985136336],
                [0.36967274900613223, 0.018303947235997597],
                [0.7088710957558425, 0.01017874807266328],
                [0.6841144173469206, 0.14115792582714903],
                [0.2526197790318786, 0.30531102977329816],
                [0.8022331882515179, 0.4018300665076793],
                [0.36202417007484644, 0.06231945138957096],
                [0.3911262625629873, 0.23054775030088803],
            ],
            [
                [0.6475591413630237, 0.4806011315711167],
                [0.37673455563997893, 0.2305467881152683],
                [0.09822063759763167, 0.4689144452408287],
                [0.05816316129992405, 0.5752466820324968],
                [0.4698720844783306, 0.9101509631176331],
                [0.6000989729234223, 0.9142169214834011],
                [0.7110949212180566, 0.1351969100128616],
                [0.07104463082685841, 0.22557203748208543],
            ],
        ],
    ]
    grid_random = [  # 2 x 3 x 2
        [
            [
                [-0.9527042297449211, -0.29340041119369453],
                [-0.041489487735896, 0.39989704014402894],
            ],
            [
                [-0.21996739884001015, -0.9546381718625283],
                [0.6250261047486634, 0.6160031367336389],
            ],
        ],
        [
            [
                [0.6250261047486634, 0.6160031367336389],
                [0.5592420918885881, -0.32290611103078315],
            ],
            [
                [-0.4332418791943833, 0.7978740054873052],
                [-0.21996739884001015, -0.9546381718625283],
            ],
        ],
    ]
    grid_corner = [  # 2 x 3 x 2
        [[[-1.0, -1.0], [-1.0, 1.0]], [[1.0, -1.0], [1.0, 1.0]]],
        [[[1.0, 1.0], [1.0, -1.0]], [[-1.0, 1.0], [-1.0, -1.0]]],
    ]

    def test_fp16(self):
        expected = [
            [
                [
                    [0.4946522116661072, 0.4969025254249573],
                    [0.5992345809936523, 0.38736796379089355],
                ],
                [
                    [0.02763419784605503, 0.3467414975166321],
                    [0.8144252896308899, 0.8391402959823608],
                ],
            ],
            [
                [
                    [0.6845056414604187, 0.12966862320899963],
                    [0.5646132230758667, 0.40902620553970337],
                ],
                [
                    [0.1310044378042221, 0.3320242762565613],
                    [0.3559671640396118, 0.4282688796520233],
                ],
            ],
        ]
        result = grid_sample(
            np.array(self.features, "float16"),
            np.array(self.grid_random, "float16"),
            align_corners=False,
        )
        self.assertEqual(result.dtype, np.float16)
        self.assertAllClose(expected, result, rtol=2e-3)

    def test_values_bilinear_random(self):
        expected = [
            [
                [
                    [0.4946522116661072, 0.4969025254249573],
                    [0.5992345809936523, 0.38736796379089355],
                ],
                [
                    [0.02763419784605503, 0.3467414975166321],
                    [0.8144252896308899, 0.8391402959823608],
                ],
            ],
            [
                [
                    [0.6845056414604187, 0.12966862320899963],
                    [0.5646132230758667, 0.40902620553970337],
                ],
                [
                    [0.1310044378042221, 0.3320242762565613],
                    [0.3559671640396118, 0.4282688796520233],
                ],
            ],
        ]
        result = grid_sample(
            np.array(self.features, "float32"),
            np.array(self.grid_random, "float32"),
            align_corners=False,
        )
        self.assertAllClose(expected, result)

    def test_values_bilinear_corner(self):
        expected = [
            [
                [
                    [0.1450890153646469, 0.24396833777427673],
                    [0.24609315395355225, 0.2453467845916748],
                ],
                [
                    [0.026439279317855835, 0.24564866721630096],
                    [0.12307910621166229, 0.05914410948753357],
                ],
            ],
            [
                [
                    [0.01776115782558918, 0.056393008679151535],
                    [0.13448593020439148, 0.015676435083150864],
                ],
                [
                    [0.16188979148864746, 0.12015028297901154],
                    [0.08675897121429443, 0.0418398417532444],
                ],
            ],
        ]
        result = grid_sample(
            np.array(self.features, "float32"),
            np.array(self.grid_corner, "float32"),
            align_corners=False,
        )
        self.assertAllClose(expected, result)

    def test_values_nearest_random(self):
        expected = [
            [
                [
                    [0.82572340965271, 0.5206645727157593],
                    [0.43934887647628784, 0.4548532962799072],
                ],
                [
                    [0.05154120549559593, 0.5912343263626099],
                    [0.8239820003509521, 0.8828994035720825],
                ],
            ],
            [
                [
                    [0.7110949158668518, 0.13519690930843353],
                    [0.3620241582393646, 0.062319450080394745],
                ],
                [
                    [0.09822063893079758, 0.4689144492149353],
                    [0.7903688549995422, 0.8681517839431763],
                ],
            ],
        ]
        result = grid_sample(
            np.array(self.features, "float32"),
            np.array(self.grid_random, "float32"),
            mode="nearest",
            align_corners=False,
        )
        self.assertAllClose(expected, result)

    def test_values_nearest_corner(self):
        expected = [
            [
                [
                    [0.5803560614585876, 0.9758733510971069],
                    [0.984372615814209, 0.9813871383666992],
                ],
                [[0.0, 0.0], [0.0, 0.0]],
            ],
            [
                [[0.0, 0.0], [0.0, 0.0]],
                [
                    [0.6475591659545898, 0.48060113191604614],
                    [0.34703588485717773, 0.1673593670129776],
                ],
            ],
        ]
        result = grid_sample(
            np.array(self.features, "float32"),
            np.array(self.grid_corner, "float32"),
            mode="nearest",
            align_corners=False,
        )
        self.assertAllClose(expected, result)

    def test_values_bilinear_random_align(self):
        expected = [
            [
                [
                    [0.7267985939979553, 0.6062460541725159],
                    [0.6733735203742981, 0.36486396193504333],
                ],
                [
                    [0.07661650329828262, 0.5985114574432373],
                    [0.8033915162086487, 0.5599108934402466],
                ],
            ],
            [
                [
                    [0.6085014343261719, 0.29785940051078796],
                    [0.6163655519485474, 0.3217147886753082],
                ],
                [
                    [0.2241607904434204, 0.37310990691185],
                    [0.6748148798942566, 0.7561057806015015],
                ],
            ],
        ]
        result = grid_sample(
            np.array(self.features, "float32"),
            np.array(self.grid_random, "float32"),
            align_corners=True,
        )
        self.assertAllClose(expected, result)

    def test_values_bilinear_corner_align(self):
        expected = [
            [
                [
                    [0.5803560614585876, 0.9758733510971069],
                    [0.984372615814209, 0.9813871383666992],
                ],
                [
                    [0.10575711727142334, 0.9825946688652039],
                    [0.49231642484664917, 0.23657643795013428],
                ],
            ],
            [
                [
                    [0.07104463130235672, 0.22557203471660614],
                    [0.5379437208175659, 0.06270574033260345],
                ],
                [
                    [0.6475591659545898, 0.48060113191604614],
                    [0.34703588485717773, 0.1673593670129776],
                ],
            ],
        ]
        result = grid_sample(
            np.array(self.features, "float32"),
            np.array(self.grid_corner, "float32"),
            align_corners=True,
        )
        self.assertAllClose(expected, result)

    def test_values_nearest_random_align(self):
        expected = [
            [
                [
                    [0.82572340965271, 0.5206645727157593],
                    [0.823407769203186, 0.3505931794643402],
                ],
                [
                    [0.05154120549559593, 0.5912343263626099],
                    [0.8239820003509521, 0.8828994035720825],
                ],
            ],
            [
                [
                    [0.7110949158668518, 0.13519690930843353],
                    [0.8022331595420837, 0.4018300771713257],
                ],
                [
                    [0.09822063893079758, 0.4689144492149353],
                    [0.7903688549995422, 0.8681517839431763],
                ],
            ],
        ]
        result = grid_sample(
            np.array(self.features, "float32"),
            np.array(self.grid_random, "float32"),
            mode="nearest",
            align_corners=True,
        )
        self.assertAllClose(expected, result)

    def test_values_nearest_corner_align(self):
        expected = [
            [
                [
                    [0.5803560614585876, 0.9758733510971069],
                    [0.984372615814209, 0.9813871383666992],
                ],
                [
                    [0.10575711727142334, 0.9825946688652039],
                    [0.49231642484664917, 0.23657643795013428],
                ],
            ],
            [
                [
                    [0.07104463130235672, 0.22557203471660614],
                    [0.5379437208175659, 0.06270574033260345],
                ],
                [
                    [0.6475591659545898, 0.48060113191604614],
                    [0.34703588485717773, 0.1673593670129776],
                ],
            ],
        ]
        result = grid_sample(
            np.array(self.features, "float32"),
            np.array(self.grid_corner, "float32"),
            mode="nearest",
            align_corners=True,
        )
        self.assertAllClose(expected, result)


class TestMakeCoords(tf.test.TestCase):

    def test_value(self):
        expected = np.array(
            [
                [
                    [-0.8, -0.833333],
                    [-0.8, -0.5],
                    [-0.8, -0.166667],
                    [-0.8, 0.166667],
                    [-0.8, 0.5],
                    [-0.8, 0.833333],
                ],
                [
                    [-0.4, -0.833333],
                    [-0.4, -0.5],
                    [-0.4, -0.166667],
                    [-0.4, 0.166667],
                    [-0.4, 0.5],
                    [-0.4, 0.833333],
                ],
                [
                    [0.0, -0.833333],
                    [0.0, -0.5],
                    [0.0, -0.166667],
                    [0.0, 0.166667],
                    [0.0, 0.5],
                    [0.0, 0.833333],
                ],
                [
                    [0.4, -0.833333],
                    [0.4, -0.5],
                    [0.4, -0.166667],
                    [0.4, 0.166667],
                    [0.4, 0.5],
                    [0.4, 0.833333],
                ],
                [
                    [0.8, -0.833333],
                    [0.8, -0.5],
                    [0.8, -0.166667],
                    [0.8, 0.166667],
                    [0.8, 0.5],
                    [0.8, 0.833333],
                ],
            ],
            "float32",
        )[None].repeat(3, axis=0)

        result = make_coords(np.zeros([3, 5, 6, 1]).astype("float32"))
        self.assertAllClose(expected, result)
        self.assertDTypeEqual(result, expected.dtype)

        result = make_coords([3, 5, 6])
        self.assertAllClose(expected, result)
        self.assertDTypeEqual(result, expected.dtype)

        result = make_coords(tf.unstack([3, 5, 6]))
        self.assertAllClose(expected, result)
        self.assertDTypeEqual(result, expected.dtype)

    def test_uint8(self):
        inputs = tf.zeros([2, 16, 16, 1], "uint8")
        result = make_coords(inputs)
        self.assertListEqual(result.shape.as_list(), [2, 16, 16, 2])
        self.assertDTypeEqual(result, "float32")

    def test_fp16(self):
        expected = np.array(
            [
                [
                    [-0.8, -0.833333],
                    [-0.8, -0.5],
                    [-0.8, -0.166667],
                    [-0.8, 0.166667],
                    [-0.8, 0.5],
                    [-0.8, 0.833333],
                ],
                [
                    [-0.4, -0.833333],
                    [-0.4, -0.5],
                    [-0.4, -0.166667],
                    [-0.4, 0.166667],
                    [-0.4, 0.5],
                    [-0.4, 0.833333],
                ],
                [
                    [0.0, -0.833333],
                    [0.0, -0.5],
                    [0.0, -0.166667],
                    [0.0, 0.166667],
                    [0.0, 0.5],
                    [0.0, 0.833333],
                ],
                [
                    [0.4, -0.833333],
                    [0.4, -0.5],
                    [0.4, -0.166667],
                    [0.4, 0.166667],
                    [0.4, 0.5],
                    [0.4, 0.833333],
                ],
                [
                    [0.8, -0.833333],
                    [0.8, -0.5],
                    [0.8, -0.166667],
                    [0.8, 0.166667],
                    [0.8, 0.5],
                    [0.8, 0.833333],
                ],
            ],
            "float16",
        )[None].repeat(3, axis=0)

        result = make_coords(np.zeros([3, 5, 6, 1]).astype("float16"))
        self.assertAllClose(expected, result, rtol=3e-3)
        self.assertDTypeEqual(result, expected.dtype)

        result = make_coords([3, 5, 6])
        self.assertAllClose(expected, result, rtol=3e-3)
        self.assertDTypeEqual(result, expected.dtype)

        result = make_coords(tf.unstack([3, 5, 6]))
        self.assertAllClose(expected, result, rtol=3e-3)
        self.assertDTypeEqual(result, expected.dtype)


class TestQueryFeatures(tf.test.TestCase):

    def test_simple(self):
        features = (
            np.arange(15)
            .reshape([1, 3, 5, 1])
            .transpose(3, 2, 1, 0)
            .astype("float32")
        )
        coords = make_coords(np.zeros([1, 6, 4, 1]))
        expected = np.array(
            [
                [
                    [
                        [0.0, -0.16666651, -0.24999994],
                        [5.0, -0.16666651, -0.75],
                        [5.0, -0.16666651, 0.75],
                        [10.0, -0.16666651, 0.24999994],
                    ],
                    [
                        [1.0, -0.49999982, -0.24999994],
                        [6.0, -0.49999982, -0.75],
                        [6.0, -0.49999982, 0.75],
                        [11.0, -0.49999982, 0.24999994],
                    ],
                    [
                        [2.0, -0.83333313, -0.24999994],
                        [7.0, -0.83333313, -0.75],
                        [7.0, -0.83333313, 0.75],
                        [12.0, -0.83333313, 0.24999994],
                    ],
                    [
                        [2.0, 0.83333343, -0.24999994],
                        [7.0, 0.83333343, -0.75],
                        [7.0, 0.83333343, 0.75],
                        [12.0, 0.83333343, 0.24999994],
                    ],
                    [
                        [3.0, 0.5000001, -0.24999994],
                        [8.0, 0.5000001, -0.75],
                        [8.0, 0.5000001, 0.75],
                        [13.0, 0.5000001, 0.24999994],
                    ],
                    [
                        [4.0, 0.1666671, -0.24999994],
                        [9.0, 0.1666671, -0.75],
                        [9.0, 0.1666671, 0.75],
                        [14.0, 0.1666671, 0.24999994],
                    ],
                ]
            ],
            "float32",
        )

        result = query_features(
            features,
            coords,
            tf.identity,
            posnet=None,
            cells=None,
            feat_unfold=False,
            local_ensemble=False,
        )

        self.assertAllClose(expected, result)
        self.assertDTypeEqual(result, np.float32)

    def test_fp16(self):
        features = (
            np.arange(15)
            .reshape([1, 3, 5, 1])
            .transpose(3, 2, 1, 0)
            .astype("float16")
        )
        coords = make_coords(np.zeros([1, 6, 4, 1]))
        expected = np.array(
            [
                [
                    [
                        [0.0, -0.16666651, -0.24999994],
                        [5.0, -0.16666651, -0.75],
                        [5.0, -0.16666651, 0.75],
                        [10.0, -0.16666651, 0.24999994],
                    ],
                    [
                        [1.0, -0.49999982, -0.24999994],
                        [6.0, -0.49999982, -0.75],
                        [6.0, -0.49999982, 0.75],
                        [11.0, -0.49999982, 0.24999994],
                    ],
                    [
                        [2.0, -0.83333313, -0.24999994],
                        [7.0, -0.83333313, -0.75],
                        [7.0, -0.83333313, 0.75],
                        [12.0, -0.83333313, 0.24999994],
                    ],
                    [
                        [2.0, 0.83333343, -0.24999994],
                        [7.0, 0.83333343, -0.75],
                        [7.0, 0.83333343, 0.75],
                        [12.0, 0.83333343, 0.24999994],
                    ],
                    [
                        [3.0, 0.5000001, -0.24999994],
                        [8.0, 0.5000001, -0.75],
                        [8.0, 0.5000001, 0.75],
                        [13.0, 0.5000001, 0.24999994],
                    ],
                    [
                        [4.0, 0.1666671, -0.24999994],
                        [9.0, 0.1666671, -0.75],
                        [9.0, 0.1666671, 0.75],
                        [14.0, 0.1666671, 0.24999994],
                    ],
                ]
            ],
            "float16",
        )

        result = query_features(
            features,
            coords,
            tf.identity,
            posnet=None,
            cells=None,
            feat_unfold=False,
            local_ensemble=False,
        )

        self.assertAllClose(expected, result, rtol=2e-2)
        self.assertDTypeEqual(result, np.float16)

    def test_cell(self):
        features = (
            np.arange(15)
            .reshape([1, 3, 5, 1])
            .transpose(3, 2, 1, 0)
            .astype("float32")
        )
        coords = make_coords(np.zeros([1, 6, 4, 1]))
        cells = np.ones((1, 6, 4, 2)) * 2 / np.array([6, 4])
        expected = np.array(
            [
                [
                    [
                        [0.0, -0.16666651, -0.24999994, 1.6666667, 1.5],
                        [5.0, -0.16666651, -0.75, 1.6666667, 1.5],
                        [5.0, -0.16666651, 0.75, 1.6666667, 1.5],
                        [10.0, -0.16666651, 0.24999994, 1.6666667, 1.5],
                    ],
                    [
                        [1.0, -0.49999982, -0.24999994, 1.6666667, 1.5],
                        [6.0, -0.49999982, -0.75, 1.6666667, 1.5],
                        [6.0, -0.49999982, 0.75, 1.6666667, 1.5],
                        [11.0, -0.49999982, 0.24999994, 1.6666667, 1.5],
                    ],
                    [
                        [2.0, -0.83333313, -0.24999994, 1.6666667, 1.5],
                        [7.0, -0.83333313, -0.75, 1.6666667, 1.5],
                        [7.0, -0.83333313, 0.75, 1.6666667, 1.5],
                        [12.0, -0.83333313, 0.24999994, 1.6666667, 1.5],
                    ],
                    [
                        [2.0, 0.83333343, -0.24999994, 1.6666667, 1.5],
                        [7.0, 0.83333343, -0.75, 1.6666667, 1.5],
                        [7.0, 0.83333343, 0.75, 1.6666667, 1.5],
                        [12.0, 0.83333343, 0.24999994, 1.6666667, 1.5],
                    ],
                    [
                        [3.0, 0.5000001, -0.24999994, 1.6666667, 1.5],
                        [8.0, 0.5000001, -0.75, 1.6666667, 1.5],
                        [8.0, 0.5000001, 0.75, 1.6666667, 1.5],
                        [13.0, 0.5000001, 0.24999994, 1.6666667, 1.5],
                    ],
                    [
                        [4.0, 0.1666671, -0.24999994, 1.6666667, 1.5],
                        [9.0, 0.1666671, -0.75, 1.6666667, 1.5],
                        [9.0, 0.1666671, 0.75, 1.6666667, 1.5],
                        [14.0, 0.1666671, 0.24999994, 1.6666667, 1.5],
                    ],
                ]
            ],
            "float32",
        )

        result = query_features(
            features,
            coords,
            tf.identity,
            posnet=None,
            cells=cells,
            feat_unfold=False,
            local_ensemble=False,
        )

        self.assertAllClose(expected, result)

    def test_unfold(self):
        features = (
            np.arange(15)
            .reshape([1, 3, 5, 1])
            .transpose(3, 2, 1, 0)
            .astype("float32")
        )
        coords = make_coords(np.zeros([1, 6, 4, 1]))
        expected = np.array(
            [
                [
                    [
                        [
                            0.0,
                            0.0,
                            0.0,
                            0.0,
                            0.0,
                            5.0,
                            0.0,
                            1.0,
                            6.0,
                            -0.16666651,
                            -0.24999994,
                        ],
                        [
                            0.0,
                            0.0,
                            0.0,
                            0.0,
                            5.0,
                            10.0,
                            1.0,
                            6.0,
                            11.0,
                            -0.16666651,
                            -0.75,
                        ],
                        [
                            0.0,
                            0.0,
                            0.0,
                            0.0,
                            5.0,
                            10.0,
                            1.0,
                            6.0,
                            11.0,
                            -0.16666651,
                            0.75,
                        ],
                        [
                            0.0,
                            0.0,
                            0.0,
                            5.0,
                            10.0,
                            0.0,
                            6.0,
                            11.0,
                            0.0,
                            -0.16666651,
                            0.24999994,
                        ],
                    ],
                    [
                        [
                            0.0,
                            0.0,
                            5.0,
                            0.0,
                            1.0,
                            6.0,
                            0.0,
                            2.0,
                            7.0,
                            -0.49999982,
                            -0.24999994,
                        ],
                        [
                            0.0,
                            5.0,
                            10.0,
                            1.0,
                            6.0,
                            11.0,
                            2.0,
                            7.0,
                            12.0,
                            -0.49999982,
                            -0.75,
                        ],
                        [
                            0.0,
                            5.0,
                            10.0,
                            1.0,
                            6.0,
                            11.0,
                            2.0,
                            7.0,
                            12.0,
                            -0.49999982,
                            0.75,
                        ],
                        [
                            5.0,
                            10.0,
                            0.0,
                            6.0,
                            11.0,
                            0.0,
                            7.0,
                            12.0,
                            0.0,
                            -0.49999982,
                            0.24999994,
                        ],
                    ],
                    [
                        [
                            0.0,
                            1.0,
                            6.0,
                            0.0,
                            2.0,
                            7.0,
                            0.0,
                            3.0,
                            8.0,
                            -0.83333313,
                            -0.24999994,
                        ],
                        [
                            1.0,
                            6.0,
                            11.0,
                            2.0,
                            7.0,
                            12.0,
                            3.0,
                            8.0,
                            13.0,
                            -0.83333313,
                            -0.75,
                        ],
                        [
                            1.0,
                            6.0,
                            11.0,
                            2.0,
                            7.0,
                            12.0,
                            3.0,
                            8.0,
                            13.0,
                            -0.83333313,
                            0.75,
                        ],
                        [
                            6.0,
                            11.0,
                            0.0,
                            7.0,
                            12.0,
                            0.0,
                            8.0,
                            13.0,
                            0.0,
                            -0.83333313,
                            0.24999994,
                        ],
                    ],
                    [
                        [
                            0.0,
                            1.0,
                            6.0,
                            0.0,
                            2.0,
                            7.0,
                            0.0,
                            3.0,
                            8.0,
                            0.83333343,
                            -0.24999994,
                        ],
                        [
                            1.0,
                            6.0,
                            11.0,
                            2.0,
                            7.0,
                            12.0,
                            3.0,
                            8.0,
                            13.0,
                            0.83333343,
                            -0.75,
                        ],
                        [
                            1.0,
                            6.0,
                            11.0,
                            2.0,
                            7.0,
                            12.0,
                            3.0,
                            8.0,
                            13.0,
                            0.83333343,
                            0.75,
                        ],
                        [
                            6.0,
                            11.0,
                            0.0,
                            7.0,
                            12.0,
                            0.0,
                            8.0,
                            13.0,
                            0.0,
                            0.83333343,
                            0.24999994,
                        ],
                    ],
                    [
                        [
                            0.0,
                            2.0,
                            7.0,
                            0.0,
                            3.0,
                            8.0,
                            0.0,
                            4.0,
                            9.0,
                            0.5000001,
                            -0.24999994,
                        ],
                        [
                            2.0,
                            7.0,
                            12.0,
                            3.0,
                            8.0,
                            13.0,
                            4.0,
                            9.0,
                            14.0,
                            0.5000001,
                            -0.75,
                        ],
                        [
                            2.0,
                            7.0,
                            12.0,
                            3.0,
                            8.0,
                            13.0,
                            4.0,
                            9.0,
                            14.0,
                            0.5000001,
                            0.75,
                        ],
                        [
                            7.0,
                            12.0,
                            0.0,
                            8.0,
                            13.0,
                            0.0,
                            9.0,
                            14.0,
                            0.0,
                            0.5000001,
                            0.24999994,
                        ],
                    ],
                    [
                        [
                            0.0,
                            3.0,
                            8.0,
                            0.0,
                            4.0,
                            9.0,
                            0.0,
                            0.0,
                            0.0,
                            0.1666671,
                            -0.24999994,
                        ],
                        [
                            3.0,
                            8.0,
                            13.0,
                            4.0,
                            9.0,
                            14.0,
                            0.0,
                            0.0,
                            0.0,
                            0.1666671,
                            -0.75,
                        ],
                        [
                            3.0,
                            8.0,
                            13.0,
                            4.0,
                            9.0,
                            14.0,
                            0.0,
                            0.0,
                            0.0,
                            0.1666671,
                            0.75,
                        ],
                        [
                            8.0,
                            13.0,
                            0.0,
                            9.0,
                            14.0,
                            0.0,
                            0.0,
                            0.0,
                            0.0,
                            0.1666671,
                            0.24999994,
                        ],
                    ],
                ]
            ],
            "float32",
        )

        result = query_features(
            features,
            coords,
            tf.identity,
            posnet=None,
            cells=None,
            feat_unfold=3,
            local_ensemble=False,
        )

        self.assertAllClose(expected, result)

    def test_local(self):
        features = (
            np.arange(15)
            .reshape([1, 3, 5, 1])
            .transpose(3, 2, 1, 0)
            .astype("float32")
        )
        coords = make_coords(np.zeros([1, 6, 4, 1]))
        expected = np.array(
            [
                [
                    [
                        [0.0000000e00, -1.6666651e-01, -2.4999994e-01],
                        [3.1250000e00, -1.6666651e-01, 0.0000000e00],
                        [6.8750000e00, -1.6666651e-01, 0.0000000e00],
                        [1.0000000e01, -1.6666651e-01, 2.4999994e-01],
                    ],
                    [
                        [7.5000006e-01, 2.9802322e-08, -2.4999993e-01],
                        [3.8750002e00, -1.4901161e-08, 0.0000000e00],
                        [7.6250010e00, -1.4901161e-08, 0.0000000e00],
                        [1.0750000e01, 2.9802322e-08, 2.4999993e-01],
                    ],
                    [
                        [1.5833335e00, -2.9802322e-08, -2.4999994e-01],
                        [4.7083330e00, 0.0000000e00, 0.0000000e00],
                        [8.4583340e00, 1.4901161e-08, 0.0000000e00],
                        [1.1583332e01, -2.9802322e-08, 2.4999994e-01],
                    ],
                    [
                        [2.4166665e00, 0.0000000e00, -2.4999996e-01],
                        [5.5416670e00, 2.9802322e-08, -2.9802322e-08],
                        [9.2916679e00, 4.4703484e-08, 0.0000000e00],
                        [1.2416668e01, 0.0000000e00, 2.4999996e-01],
                    ],
                    [
                        [3.2499995e00, 0.0000000e00, -2.4999993e-01],
                        [6.3750000e00, 1.4901161e-08, 7.4505806e-09],
                        [1.0125000e01, 1.4901161e-08, -7.4505806e-09],
                        [1.3249998e01, 0.0000000e00, 2.4999993e-01],
                    ],
                    [
                        [4.0000000e00, 1.6666710e-01, -2.4999994e-01],
                        [7.1250000e00, 1.6666710e-01, 0.0000000e00],
                        [1.0875000e01, 1.6666710e-01, 0.0000000e00],
                        [1.4000000e01, 1.6666710e-01, 2.4999994e-01],
                    ],
                ]
            ],
            "float32",
        )

        result = query_features(
            features,
            coords,
            tf.identity,
            posnet=None,
            cells=None,
            feat_unfold=False,
            local_ensemble=True,
        )

        self.assertAllClose(expected, result)

    def test_complex(self):
        features = (
            np.arange(60)
            .reshape([2, 3, 5, 2])
            .transpose(3, 2, 1, 0)
            .astype("float32")
        )
        coords = make_coords(np.zeros([2, 6, 4, 1]))
        cells = np.ones((2, 6, 4, 2)) * 2 / np.array([6, 4])
        expected = np.array(
            [
                [
                    [
                        [
                            0.0000000e00,
                            0.0000000e00,
                            0.0000000e00,
                            0.0000000e00,
                            0.0000000e00,
                            1.0000000e01,
                            0.0000000e00,
                            2.0000000e00,
                            1.2000000e01,
                            0.0000000e00,
                            0.0000000e00,
                            0.0000000e00,
                            0.0000000e00,
                            3.0000000e01,
                            4.0000000e01,
                            0.0000000e00,
                            3.2000000e01,
                            4.2000000e01,
                            -1.6666651e-01,
                            -2.4999994e-01,
                            1.6666667e00,
                            1.5000000e00,
                        ],
                        [
                            0.0000000e00,
                            0.0000000e00,
                            0.0000000e00,
                            0.0000000e00,
                            6.2500000e00,
                            1.6250000e01,
                            1.2500000e00,
                            8.2500000e00,
                            1.8250000e01,
                            0.0000000e00,
                            0.0000000e00,
                            0.0000000e00,
                            1.8750000e01,
                            3.6250000e01,
                            4.6250000e01,
                            2.0000000e01,
                            3.8250000e01,
                            4.8250000e01,
                            -1.6666651e-01,
                            0.0000000e00,
                            1.6666667e00,
                            1.5000000e00,
                        ],
                        [
                            0.0000000e00,
                            0.0000000e00,
                            0.0000000e00,
                            3.7500000e00,
                            1.3750000e01,
                            1.2500000e01,
                            5.7500000e00,
                            1.5750000e01,
                            1.3750000e01,
                            0.0000000e00,
                            0.0000000e00,
                            0.0000000e00,
                            3.3750000e01,
                            4.3750000e01,
                            3.1250000e01,
                            3.5750000e01,
                            4.5750000e01,
                            3.2500000e01,
                            -1.6666651e-01,
                            0.0000000e00,
                            1.6666667e00,
                            1.5000000e00,
                        ],
                        [
                            0.0000000e00,
                            0.0000000e00,
                            0.0000000e00,
                            1.0000000e01,
                            2.0000000e01,
                            0.0000000e00,
                            1.2000000e01,
                            2.2000000e01,
                            0.0000000e00,
                            0.0000000e00,
                            0.0000000e00,
                            0.0000000e00,
                            4.0000000e01,
                            5.0000000e01,
                            0.0000000e00,
                            4.2000000e01,
                            5.2000000e01,
                            0.0000000e00,
                            -1.6666651e-01,
                            2.4999994e-01,
                            1.6666667e00,
                            1.5000000e00,
                        ],
                    ],
                    [
                        [
                            0.0000000e00,
                            0.0000000e00,
                            7.5000005e00,
                            0.0000000e00,
                            1.5000001e00,
                            1.1500000e01,
                            0.0000000e00,
                            3.5000000e00,
                            1.3500000e01,
                            0.0000000e00,
                            2.2500002e01,
                            3.0000002e01,
                            0.0000000e00,
                            3.1500000e01,
                            4.1499996e01,
                            0.0000000e00,
                            3.3500000e01,
                            4.3500000e01,
                            2.9802322e-08,
                            -2.4999993e-01,
                            1.6666665e00,
                            1.5000000e00,
                        ],
                        [
                            0.0000000e00,
                            4.6875005e00,
                            1.2187502e01,
                            9.3750012e-01,
                            7.7500005e00,
                            1.7750000e01,
                            2.1875000e00,
                            9.7500000e00,
                            1.9750000e01,
                            1.4062502e01,
                            2.7187504e01,
                            3.4687508e01,
                            1.9687500e01,
                            3.7750000e01,
                            4.7750004e01,
                            2.0937500e01,
                            3.9750000e01,
                            4.9750004e01,
                            -1.4901161e-08,
                            0.0000000e00,
                            1.6666667e00,
                            1.5000001e00,
                        ],
                        [
                            2.8125005e00,
                            1.0312502e01,
                            9.3750010e00,
                            5.2500005e00,
                            1.5250002e01,
                            1.3437500e01,
                            7.2500010e00,
                            1.7250002e01,
                            1.4687500e01,
                            2.5312504e01,
                            3.2812504e01,
                            2.3437504e01,
                            3.5250004e01,
                            4.5250000e01,
                            3.2187500e01,
                            3.7250004e01,
                            4.7250004e01,
                            3.3437500e01,
                            -1.4901161e-08,
                            0.0000000e00,
                            1.6666667e00,
                            1.5000001e00,
                        ],
                        [
                            7.5000005e00,
                            1.5000001e01,
                            0.0000000e00,
                            1.1500000e01,
                            2.1500000e01,
                            0.0000000e00,
                            1.3500000e01,
                            2.3500000e01,
                            0.0000000e00,
                            3.0000002e01,
                            3.7500004e01,
                            0.0000000e00,
                            4.1499996e01,
                            5.1500000e01,
                            0.0000000e00,
                            4.3500000e01,
                            5.3500000e01,
                            0.0000000e00,
                            2.9802322e-08,
                            2.4999993e-01,
                            1.6666665e00,
                            1.5000000e00,
                        ],
                    ],
                    [
                        [
                            0.0000000e00,
                            1.1666669e00,
                            1.1166666e01,
                            0.0000000e00,
                            3.1666670e00,
                            1.3166666e01,
                            0.0000000e00,
                            5.1666670e00,
                            1.5166666e01,
                            0.0000000e00,
                            3.1166668e01,
                            4.1166664e01,
                            0.0000000e00,
                            3.3166664e01,
                            4.3166664e01,
                            0.0000000e00,
                            3.5166664e01,
                            4.5166664e01,
                            -2.9802322e-08,
                            -2.4999994e-01,
                            1.6666667e00,
                            1.5000000e00,
                        ],
                        [
                            7.2916681e-01,
                            7.4166670e00,
                            1.7416668e01,
                            1.9791667e00,
                            9.4166660e00,
                            1.9416668e01,
                            3.2291670e00,
                            1.1416666e01,
                            2.1416668e01,
                            1.9479168e01,
                            3.7416668e01,
                            4.7416664e01,
                            2.0729168e01,
                            3.9416664e01,
                            4.9416668e01,
                            2.1979168e01,
                            4.1416664e01,
                            5.1416664e01,
                            0.0000000e00,
                            0.0000000e00,
                            1.6666667e00,
                            1.5000000e00,
                        ],
                        [
                            4.9166670e00,
                            1.4916666e01,
                            1.3229167e01,
                            6.9166670e00,
                            1.6916668e01,
                            1.4479167e01,
                            8.9166670e00,
                            1.8916668e01,
                            1.5729167e01,
                            3.4916668e01,
                            4.4916664e01,
                            3.1979168e01,
                            3.6916668e01,
                            4.6916664e01,
                            3.3229168e01,
                            3.8916664e01,
                            4.8916664e01,
                            3.4479164e01,
                            1.4901161e-08,
                            0.0000000e00,
                            1.6666666e00,
                            1.5000000e00,
                        ],
                        [
                            1.1166666e01,
                            2.1166668e01,
                            0.0000000e00,
                            1.3166666e01,
                            2.3166664e01,
                            0.0000000e00,
                            1.5166666e01,
                            2.5166666e01,
                            0.0000000e00,
                            4.1166664e01,
                            5.1166664e01,
                            0.0000000e00,
                            4.3166664e01,
                            5.3166668e01,
                            0.0000000e00,
                            4.5166664e01,
                            5.5166664e01,
                            0.0000000e00,
                            -2.9802322e-08,
                            2.4999994e-01,
                            1.6666667e00,
                            1.5000000e00,
                        ],
                    ],
                    [
                        [
                            0.0000000e00,
                            2.8333335e00,
                            1.2833334e01,
                            0.0000000e00,
                            4.8333330e00,
                            1.4833334e01,
                            0.0000000e00,
                            6.8333340e00,
                            1.6833334e01,
                            0.0000000e00,
                            3.2833332e01,
                            4.2833336e01,
                            0.0000000e00,
                            3.4833332e01,
                            4.4833336e01,
                            0.0000000e00,
                            3.6833336e01,
                            4.6833332e01,
                            0.0000000e00,
                            -2.4999996e-01,
                            1.6666667e00,
                            1.5000000e00,
                        ],
                        [
                            1.7708333e00,
                            9.0833330e00,
                            1.9083334e01,
                            3.0208335e00,
                            1.1083334e01,
                            2.1083332e01,
                            4.2708330e00,
                            1.3083334e01,
                            2.3083334e01,
                            2.0520832e01,
                            3.9083332e01,
                            4.9083332e01,
                            2.1770834e01,
                            4.1083336e01,
                            5.1083332e01,
                            2.3020832e01,
                            4.3083336e01,
                            5.3083336e01,
                            2.9802322e-08,
                            -2.9802322e-08,
                            1.6666667e00,
                            1.5000000e00,
                        ],
                        [
                            6.5833340e00,
                            1.6583334e01,
                            1.4270834e01,
                            8.5833340e00,
                            1.8583336e01,
                            1.5520835e01,
                            1.0583334e01,
                            2.0583334e01,
                            1.6770836e01,
                            3.6583336e01,
                            4.6583336e01,
                            3.3020836e01,
                            3.8583336e01,
                            4.8583336e01,
                            3.4270836e01,
                            4.0583336e01,
                            5.0583336e01,
                            3.5520836e01,
                            4.4703484e-08,
                            0.0000000e00,
                            1.6666669e00,
                            1.5000001e00,
                        ],
                        [
                            1.2833334e01,
                            2.2833332e01,
                            0.0000000e00,
                            1.4833334e01,
                            2.4833336e01,
                            0.0000000e00,
                            1.6833334e01,
                            2.6833334e01,
                            0.0000000e00,
                            4.2833336e01,
                            5.2833332e01,
                            0.0000000e00,
                            4.4833336e01,
                            5.4833332e01,
                            0.0000000e00,
                            4.6833332e01,
                            5.6833336e01,
                            0.0000000e00,
                            0.0000000e00,
                            2.4999996e-01,
                            1.6666667e00,
                            1.5000000e00,
                        ],
                    ],
                    [
                        [
                            0.0000000e00,
                            4.5000000e00,
                            1.4499998e01,
                            0.0000000e00,
                            6.4999990e00,
                            1.6499998e01,
                            0.0000000e00,
                            5.9999990e00,
                            1.3499998e01,
                            0.0000000e00,
                            3.4499996e01,
                            4.4499996e01,
                            0.0000000e00,
                            3.6499996e01,
                            4.6499996e01,
                            0.0000000e00,
                            2.8499996e01,
                            3.5999992e01,
                            0.0000000e00,
                            -2.4999993e-01,
                            1.6666666e00,
                            1.4999998e00,
                        ],
                        [
                            2.8125000e00,
                            1.0750001e01,
                            2.0750000e01,
                            4.0625000e00,
                            1.2750000e01,
                            2.2750000e01,
                            3.7499998e00,
                            1.0687499e01,
                            1.8187498e01,
                            2.1562500e01,
                            4.0750000e01,
                            5.0750000e01,
                            2.2812500e01,
                            4.2750000e01,
                            5.2750000e01,
                            1.7812498e01,
                            3.3187496e01,
                            4.0687496e01,
                            1.4901161e-08,
                            7.4505806e-09,
                            1.6666667e00,
                            1.5000000e00,
                        ],
                        [
                            8.2500000e00,
                            1.8250000e01,
                            1.5312500e01,
                            1.0250000e01,
                            2.0250000e01,
                            1.6562500e01,
                            8.8124990e00,
                            1.6312498e01,
                            1.3124999e01,
                            3.8250000e01,
                            4.8250000e01,
                            3.4062500e01,
                            4.0250000e01,
                            5.0250000e01,
                            3.5312500e01,
                            3.1312496e01,
                            3.8812496e01,
                            2.7187498e01,
                            1.4901161e-08,
                            -7.4505806e-09,
                            1.6666667e00,
                            1.5000000e00,
                        ],
                        [
                            1.4499998e01,
                            2.4499996e01,
                            0.0000000e00,
                            1.6499998e01,
                            2.6499996e01,
                            0.0000000e00,
                            1.3499998e01,
                            2.0999996e01,
                            0.0000000e00,
                            4.4499996e01,
                            5.4499992e01,
                            0.0000000e00,
                            4.6499996e01,
                            5.6499992e01,
                            0.0000000e00,
                            3.5999992e01,
                            4.3499992e01,
                            0.0000000e00,
                            0.0000000e00,
                            2.4999993e-01,
                            1.6666666e00,
                            1.4999998e00,
                        ],
                    ],
                    [
                        [
                            0.0000000e00,
                            6.0000000e00,
                            1.6000000e01,
                            0.0000000e00,
                            8.0000000e00,
                            1.8000000e01,
                            0.0000000e00,
                            0.0000000e00,
                            0.0000000e00,
                            0.0000000e00,
                            3.6000000e01,
                            4.6000000e01,
                            0.0000000e00,
                            3.8000000e01,
                            4.8000000e01,
                            0.0000000e00,
                            0.0000000e00,
                            0.0000000e00,
                            1.6666710e-01,
                            -2.4999994e-01,
                            1.6666667e00,
                            1.5000000e00,
                        ],
                        [
                            3.7500000e00,
                            1.2250000e01,
                            2.2250000e01,
                            5.0000000e00,
                            1.4250000e01,
                            2.4250000e01,
                            0.0000000e00,
                            0.0000000e00,
                            0.0000000e00,
                            2.2500000e01,
                            4.2250000e01,
                            5.2250000e01,
                            2.3750000e01,
                            4.4250000e01,
                            5.4250000e01,
                            0.0000000e00,
                            0.0000000e00,
                            0.0000000e00,
                            1.6666710e-01,
                            0.0000000e00,
                            1.6666667e00,
                            1.5000000e00,
                        ],
                        [
                            9.7500000e00,
                            1.9750000e01,
                            1.6250000e01,
                            1.1750000e01,
                            2.1750000e01,
                            1.7500000e01,
                            0.0000000e00,
                            0.0000000e00,
                            0.0000000e00,
                            3.9750000e01,
                            4.9750000e01,
                            3.5000000e01,
                            4.1750000e01,
                            5.1750000e01,
                            3.6250000e01,
                            0.0000000e00,
                            0.0000000e00,
                            0.0000000e00,
                            1.6666710e-01,
                            0.0000000e00,
                            1.6666667e00,
                            1.5000000e00,
                        ],
                        [
                            1.6000000e01,
                            2.6000000e01,
                            0.0000000e00,
                            1.8000000e01,
                            2.8000000e01,
                            0.0000000e00,
                            0.0000000e00,
                            0.0000000e00,
                            0.0000000e00,
                            4.6000000e01,
                            5.6000000e01,
                            0.0000000e00,
                            4.8000000e01,
                            5.8000000e01,
                            0.0000000e00,
                            0.0000000e00,
                            0.0000000e00,
                            0.0000000e00,
                            1.6666710e-01,
                            2.4999994e-01,
                            1.6666667e00,
                            1.5000000e00,
                        ],
                    ],
                ],
                [
                    [
                        [
                            0.0000000e00,
                            0.0000000e00,
                            0.0000000e00,
                            0.0000000e00,
                            1.0000000e00,
                            1.1000000e01,
                            0.0000000e00,
                            3.0000000e00,
                            1.3000000e01,
                            0.0000000e00,
                            0.0000000e00,
                            0.0000000e00,
                            0.0000000e00,
                            3.1000000e01,
                            4.1000000e01,
                            0.0000000e00,
                            3.3000000e01,
                            4.3000000e01,
                            -1.6666651e-01,
                            -2.4999994e-01,
                            1.6666667e00,
                            1.5000000e00,
                        ],
                        [
                            0.0000000e00,
                            0.0000000e00,
                            0.0000000e00,
                            6.2500000e-01,
                            7.2500000e00,
                            1.7250000e01,
                            1.8750000e00,
                            9.2500000e00,
                            1.9250000e01,
                            0.0000000e00,
                            0.0000000e00,
                            0.0000000e00,
                            1.9375000e01,
                            3.7250000e01,
                            4.7250000e01,
                            2.0625000e01,
                            3.9250000e01,
                            4.9250000e01,
                            -1.6666651e-01,
                            0.0000000e00,
                            1.6666667e00,
                            1.5000000e00,
                        ],
                        [
                            0.0000000e00,
                            0.0000000e00,
                            0.0000000e00,
                            4.7500000e00,
                            1.4750000e01,
                            1.3125000e01,
                            6.7500000e00,
                            1.6750000e01,
                            1.4375000e01,
                            0.0000000e00,
                            0.0000000e00,
                            0.0000000e00,
                            3.4750000e01,
                            4.4750000e01,
                            3.1875000e01,
                            3.6750000e01,
                            4.6750000e01,
                            3.3125000e01,
                            -1.6666651e-01,
                            0.0000000e00,
                            1.6666667e00,
                            1.5000000e00,
                        ],
                        [
                            0.0000000e00,
                            0.0000000e00,
                            0.0000000e00,
                            1.1000000e01,
                            2.1000000e01,
                            0.0000000e00,
                            1.3000000e01,
                            2.3000000e01,
                            0.0000000e00,
                            0.0000000e00,
                            0.0000000e00,
                            0.0000000e00,
                            4.1000000e01,
                            5.1000000e01,
                            0.0000000e00,
                            4.3000000e01,
                            5.3000000e01,
                            0.0000000e00,
                            -1.6666651e-01,
                            2.4999994e-01,
                            1.6666667e00,
                            1.5000000e00,
                        ],
                    ],
                    [
                        [
                            0.0000000e00,
                            7.5000006e-01,
                            8.2500010e00,
                            0.0000000e00,
                            2.5000000e00,
                            1.2500000e01,
                            0.0000000e00,
                            4.5000000e00,
                            1.4500000e01,
                            0.0000000e00,
                            2.3250002e01,
                            3.0750002e01,
                            0.0000000e00,
                            3.2500000e01,
                            4.2500000e01,
                            0.0000000e00,
                            3.4499996e01,
                            4.4500000e01,
                            2.9802322e-08,
                            -2.4999993e-01,
                            1.6666665e00,
                            1.5000000e00,
                        ],
                        [
                            4.6875006e-01,
                            5.4375005e00,
                            1.2937502e01,
                            1.5625002e00,
                            8.7500000e00,
                            1.8750000e01,
                            2.8125000e00,
                            1.0750000e01,
                            2.0750000e01,
                            1.4531252e01,
                            2.7937504e01,
                            3.5437508e01,
                            2.0312500e01,
                            3.8750000e01,
                            4.8750004e01,
                            2.1562500e01,
                            4.0750000e01,
                            5.0750004e01,
                            -1.4901161e-08,
                            0.0000000e00,
                            1.6666667e00,
                            1.5000001e00,
                        ],
                        [
                            3.5625007e00,
                            1.1062502e01,
                            9.8437510e00,
                            6.2500005e00,
                            1.6250002e01,
                            1.4062500e01,
                            8.2500010e00,
                            1.8250002e01,
                            1.5312500e01,
                            2.6062504e01,
                            3.3562504e01,
                            2.3906254e01,
                            3.6250004e01,
                            4.6250000e01,
                            3.2812500e01,
                            3.8250000e01,
                            4.8250004e01,
                            3.4062500e01,
                            -1.4901161e-08,
                            0.0000000e00,
                            1.6666667e00,
                            1.5000001e00,
                        ],
                        [
                            8.2500010e00,
                            1.5750001e01,
                            0.0000000e00,
                            1.2500000e01,
                            2.2500000e01,
                            0.0000000e00,
                            1.4500000e01,
                            2.4500000e01,
                            0.0000000e00,
                            3.0750002e01,
                            3.8250004e01,
                            0.0000000e00,
                            4.2500000e01,
                            5.2500000e01,
                            0.0000000e00,
                            4.4500000e01,
                            5.4500000e01,
                            0.0000000e00,
                            2.9802322e-08,
                            2.4999993e-01,
                            1.6666665e00,
                            1.5000000e00,
                        ],
                    ],
                    [
                        [
                            0.0000000e00,
                            2.1666667e00,
                            1.2166666e01,
                            0.0000000e00,
                            4.1666670e00,
                            1.4166667e01,
                            0.0000000e00,
                            6.1666670e00,
                            1.6166666e01,
                            0.0000000e00,
                            3.2166664e01,
                            4.2166664e01,
                            0.0000000e00,
                            3.4166668e01,
                            4.4166664e01,
                            0.0000000e00,
                            3.6166668e01,
                            4.6166664e01,
                            -2.9802322e-08,
                            -2.4999994e-01,
                            1.6666667e00,
                            1.5000000e00,
                        ],
                        [
                            1.3541669e00,
                            8.4166670e00,
                            1.8416666e01,
                            2.6041667e00,
                            1.0416667e01,
                            2.0416668e01,
                            3.8541667e00,
                            1.2416667e01,
                            2.2416666e01,
                            2.0104166e01,
                            3.8416664e01,
                            4.8416664e01,
                            2.1354168e01,
                            4.0416668e01,
                            5.0416664e01,
                            2.2604168e01,
                            4.2416664e01,
                            5.2416668e01,
                            0.0000000e00,
                            0.0000000e00,
                            1.6666667e00,
                            1.5000000e00,
                        ],
                        [
                            5.9166670e00,
                            1.5916666e01,
                            1.3854166e01,
                            7.9166665e00,
                            1.7916668e01,
                            1.5104166e01,
                            9.9166660e00,
                            1.9916668e01,
                            1.6354168e01,
                            3.5916664e01,
                            4.5916664e01,
                            3.2604164e01,
                            3.7916664e01,
                            4.7916664e01,
                            3.3854168e01,
                            3.9916668e01,
                            4.9916664e01,
                            3.5104168e01,
                            1.4901161e-08,
                            0.0000000e00,
                            1.6666666e00,
                            1.5000000e00,
                        ],
                        [
                            1.2166666e01,
                            2.2166666e01,
                            0.0000000e00,
                            1.4166667e01,
                            2.4166666e01,
                            0.0000000e00,
                            1.6166666e01,
                            2.6166666e01,
                            0.0000000e00,
                            4.2166664e01,
                            5.2166664e01,
                            0.0000000e00,
                            4.4166664e01,
                            5.4166664e01,
                            0.0000000e00,
                            4.6166664e01,
                            5.6166664e01,
                            0.0000000e00,
                            -2.9802322e-08,
                            2.4999994e-01,
                            1.6666667e00,
                            1.5000000e00,
                        ],
                    ],
                    [
                        [
                            0.0000000e00,
                            3.8333335e00,
                            1.3833333e01,
                            0.0000000e00,
                            5.8333335e00,
                            1.5833334e01,
                            0.0000000e00,
                            7.8333330e00,
                            1.7833334e01,
                            0.0000000e00,
                            3.3833336e01,
                            4.3833332e01,
                            0.0000000e00,
                            3.5833332e01,
                            4.5833336e01,
                            0.0000000e00,
                            3.7833332e01,
                            4.7833336e01,
                            0.0000000e00,
                            -2.4999996e-01,
                            1.6666667e00,
                            1.5000000e00,
                        ],
                        [
                            2.3958333e00,
                            1.0083333e01,
                            2.0083334e01,
                            3.6458335e00,
                            1.2083333e01,
                            2.2083334e01,
                            4.8958335e00,
                            1.4083334e01,
                            2.4083332e01,
                            2.1145832e01,
                            4.0083336e01,
                            5.0083336e01,
                            2.2395832e01,
                            4.2083332e01,
                            5.2083332e01,
                            2.3645834e01,
                            4.4083336e01,
                            5.4083332e01,
                            2.9802322e-08,
                            -2.9802322e-08,
                            1.6666667e00,
                            1.5000000e00,
                        ],
                        [
                            7.5833340e00,
                            1.7583334e01,
                            1.4895835e01,
                            9.5833340e00,
                            1.9583334e01,
                            1.6145834e01,
                            1.1583334e01,
                            2.1583336e01,
                            1.7395836e01,
                            3.7583336e01,
                            4.7583336e01,
                            3.3645836e01,
                            3.9583336e01,
                            4.9583336e01,
                            3.4895836e01,
                            4.1583336e01,
                            5.1583336e01,
                            3.6145836e01,
                            4.4703484e-08,
                            0.0000000e00,
                            1.6666669e00,
                            1.5000001e00,
                        ],
                        [
                            1.3833333e01,
                            2.3833334e01,
                            0.0000000e00,
                            1.5833334e01,
                            2.5833334e01,
                            0.0000000e00,
                            1.7833334e01,
                            2.7833332e01,
                            0.0000000e00,
                            4.3833332e01,
                            5.3833336e01,
                            0.0000000e00,
                            4.5833336e01,
                            5.5833332e01,
                            0.0000000e00,
                            4.7833336e01,
                            5.7833336e01,
                            0.0000000e00,
                            0.0000000e00,
                            2.4999996e-01,
                            1.6666667e00,
                            1.5000000e00,
                        ],
                    ],
                    [
                        [
                            0.0000000e00,
                            5.5000000e00,
                            1.5499998e01,
                            0.0000000e00,
                            7.4999990e00,
                            1.7499998e01,
                            0.0000000e00,
                            6.7499990e00,
                            1.4249998e01,
                            0.0000000e00,
                            3.5499996e01,
                            4.5499996e01,
                            0.0000000e00,
                            3.7499996e01,
                            4.7499996e01,
                            0.0000000e00,
                            2.9249996e01,
                            3.6749992e01,
                            0.0000000e00,
                            -2.4999993e-01,
                            1.6666666e00,
                            1.4999998e00,
                        ],
                        [
                            3.4375000e00,
                            1.1750000e01,
                            2.1750000e01,
                            4.6875000e00,
                            1.3750000e01,
                            2.3750000e01,
                            4.2187495e00,
                            1.1437499e01,
                            1.8937498e01,
                            2.2187500e01,
                            4.1750000e01,
                            5.1750000e01,
                            2.3437500e01,
                            4.3750000e01,
                            5.3750000e01,
                            1.8281248e01,
                            3.3937496e01,
                            4.1437496e01,
                            1.4901161e-08,
                            7.4505806e-09,
                            1.6666667e00,
                            1.5000000e00,
                        ],
                        [
                            9.2500000e00,
                            1.9249998e01,
                            1.5937500e01,
                            1.1250000e01,
                            2.1250000e01,
                            1.7187500e01,
                            9.5624990e00,
                            1.7062498e01,
                            1.3593749e01,
                            3.9249996e01,
                            4.9250000e01,
                            3.4687500e01,
                            4.1250000e01,
                            5.1250000e01,
                            3.5937500e01,
                            3.2062496e01,
                            3.9562496e01,
                            2.7656248e01,
                            1.4901161e-08,
                            -7.4505806e-09,
                            1.6666667e00,
                            1.5000000e00,
                        ],
                        [
                            1.5499998e01,
                            2.5499996e01,
                            0.0000000e00,
                            1.7499998e01,
                            2.7499996e01,
                            0.0000000e00,
                            1.4249998e01,
                            2.1749996e01,
                            0.0000000e00,
                            4.5499996e01,
                            5.5499992e01,
                            0.0000000e00,
                            4.7499996e01,
                            5.7499992e01,
                            0.0000000e00,
                            3.6749992e01,
                            4.4249992e01,
                            0.0000000e00,
                            0.0000000e00,
                            2.4999993e-01,
                            1.6666666e00,
                            1.4999998e00,
                        ],
                    ],
                    [
                        [
                            0.0000000e00,
                            7.0000000e00,
                            1.7000000e01,
                            0.0000000e00,
                            9.0000000e00,
                            1.9000000e01,
                            0.0000000e00,
                            0.0000000e00,
                            0.0000000e00,
                            0.0000000e00,
                            3.7000000e01,
                            4.7000000e01,
                            0.0000000e00,
                            3.9000000e01,
                            4.9000000e01,
                            0.0000000e00,
                            0.0000000e00,
                            0.0000000e00,
                            1.6666710e-01,
                            -2.4999994e-01,
                            1.6666667e00,
                            1.5000000e00,
                        ],
                        [
                            4.3750000e00,
                            1.3250000e01,
                            2.3250000e01,
                            5.6250000e00,
                            1.5250000e01,
                            2.5250000e01,
                            0.0000000e00,
                            0.0000000e00,
                            0.0000000e00,
                            2.3125000e01,
                            4.3250000e01,
                            5.3250000e01,
                            2.4375000e01,
                            4.5250000e01,
                            5.5250000e01,
                            0.0000000e00,
                            0.0000000e00,
                            0.0000000e00,
                            1.6666710e-01,
                            0.0000000e00,
                            1.6666667e00,
                            1.5000000e00,
                        ],
                        [
                            1.0750000e01,
                            2.0750000e01,
                            1.6875000e01,
                            1.2750000e01,
                            2.2750000e01,
                            1.8125000e01,
                            0.0000000e00,
                            0.0000000e00,
                            0.0000000e00,
                            4.0750000e01,
                            5.0750000e01,
                            3.5625000e01,
                            4.2750000e01,
                            5.2750000e01,
                            3.6875000e01,
                            0.0000000e00,
                            0.0000000e00,
                            0.0000000e00,
                            1.6666710e-01,
                            0.0000000e00,
                            1.6666667e00,
                            1.5000000e00,
                        ],
                        [
                            1.7000000e01,
                            2.7000000e01,
                            0.0000000e00,
                            1.9000000e01,
                            2.9000000e01,
                            0.0000000e00,
                            0.0000000e00,
                            0.0000000e00,
                            0.0000000e00,
                            4.7000000e01,
                            5.7000000e01,
                            0.0000000e00,
                            4.9000000e01,
                            5.9000000e01,
                            0.0000000e00,
                            0.0000000e00,
                            0.0000000e00,
                            0.0000000e00,
                            1.6666710e-01,
                            2.4999994e-01,
                            1.6666667e00,
                            1.5000000e00,
                        ],
                    ],
                ],
            ],
            "float32",
        )

        # Channel order in torch.nn.functional.unfold id different from
        # tf.image.extract_patches
        expected = np.concatenate(
            [
                np.concatenate(
                    [
                        expected[:1, ..., :-4]
                        .reshape([1, 6, 4, 2, 9])
                        .transpose(0, 1, 2, 4, 3)
                        .reshape([1, 6, 4, 18]),
                        expected[:1, ..., -4:],
                    ],
                    axis=-1,
                ),
                np.concatenate(
                    [
                        expected[1:, ..., :-4]
                        .reshape([1, 6, 4, 2, 9])
                        .transpose(0, 1, 2, 4, 3)
                        .reshape([1, 6, 4, 18]),
                        expected[1:, ..., -4:],
                    ],
                    axis=-1,
                ),
            ],
            axis=0,
        )

        result = query_features(
            features,
            coords,
            tf.identity,
            posnet=None,
            cells=cells,
            feat_unfold=3,
            local_ensemble=True,
        )

        self.assertAllClose(expected, result)

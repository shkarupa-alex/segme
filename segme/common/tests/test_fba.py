import numpy as np
from keras.src import testing

from segme.common.fba import FBAFusion


class TestFBAFusion(testing.TestCase):
    def test_layer(self):
        self.run_layer_test(
            FBAFusion,
            init_kwargs={
                "inference_only": True,
                "alpha_variance": 10.0,
                "num_repeats": 1,
            },
            input_shape=(
                (2, 128, 128, 3),
                (2, 128, 128, 3),
                (2, 128, 128, 3),
                (2, 128, 128, 1),
            ),
            input_dtype=("float32",) * 4,
            expected_output_shape=(
                (2, 128, 128, 3),
                (2, 128, 128, 3),
                (2, 128, 128, 1),
            ),
            expected_output_dtype=("float32",) * 3,
        )
        self.run_layer_test(
            FBAFusion,
            init_kwargs={
                "inference_only": False,
                "alpha_variance": 1.0,
                "num_repeats": 3,
            },
            input_shape=(
                (2, 128, 128, 3),
                (2, 128, 128, 3),
                (2, 128, 128, 3),
                (2, 128, 128, 1),
            ),
            input_dtype=("float32",) * 4,
            expected_output_shape=(
                (2, 128, 128, 3),
                (2, 128, 128, 3),
                (2, 128, 128, 1),
            ),
            expected_output_dtype=("float32",) * 3,
        )

    def test_value(self):
        source_alpha = np.array(
            [
                [
                    0.11649738,
                    0.34115862,
                    0.19901514,
                    0.44254727,
                    0.45125985,
                    0.2719126,
                    0.41972925,
                    0.08259951,
                ],
                [
                    0.31859556,
                    0.58595064,
                    0.8502705,
                    0.53112322,
                    0.21173297,
                    0.32449187,
                    0.69178452,
                    0.41772451,
                ],
                [
                    0.41550831,
                    0.93873406,
                    0.56715244,
                    0.31370676,
                    0.60112384,
                    0.17276844,
                    0.75918609,
                    0.41935488,
                ],
                [
                    0.51629702,
                    0.4762876,
                    0.30891746,
                    0.04081906,
                    0.67440964,
                    0.22038393,
                    0.18573692,
                    0.54769703,
                ],
                [
                    0.24767802,
                    0.09670356,
                    0.29982668,
                    0.977317,
                    0.37386934,
                    0.22803611,
                    0.23364739,
                    0.49589258,
                ],
                [
                    0.12647578,
                    0.60022568,
                    0.94870173,
                    0.19177922,
                    0.4797057,
                    0.97408934,
                    0.52970402,
                    0.26436536,
                ],
                [
                    0.63480539,
                    0.34611172,
                    0.38532207,
                    0.4926412,
                    0.58006,
                    0.02679589,
                    0.46170613,
                    0.35559601,
                ],
                [
                    0.71240281,
                    0.32688286,
                    0.22205559,
                    0.8980536,
                    0.31020264,
                    0.31515843,
                    0.42277988,
                    0.65471292,
                ],
            ],
            "float32",
        ).reshape((1, 8, 8, 1))
        source_image = (
            np.array(
                [
                    21,
                    180,
                    6,
                    60,
                    59,
                    26,
                    121,
                    8,
                    182,
                    164,
                    172,
                    244,
                    32,
                    218,
                    166,
                    218,
                    155,
                    154,
                    254,
                    16,
                    155,
                    58,
                    195,
                    48,
                    74,
                    113,
                    33,
                    162,
                    28,
                    98,
                    188,
                    28,
                    69,
                    67,
                    133,
                    200,
                    62,
                    126,
                    116,
                    21,
                    57,
                    227,
                    69,
                    49,
                    119,
                    111,
                    39,
                    243,
                    250,
                    25,
                    253,
                    80,
                    232,
                    227,
                    159,
                    36,
                    65,
                    114,
                    173,
                    208,
                    68,
                    242,
                    196,
                    122,
                    109,
                    183,
                    110,
                    30,
                    253,
                    148,
                    143,
                    247,
                    183,
                    152,
                    69,
                    189,
                    176,
                    245,
                    74,
                    193,
                    164,
                    70,
                    78,
                    147,
                    12,
                    120,
                    77,
                    251,
                    184,
                    63,
                    186,
                    181,
                    57,
                    106,
                    5,
                    83,
                    105,
                    114,
                    236,
                    196,
                    217,
                    183,
                    106,
                    12,
                    160,
                    45,
                    134,
                    206,
                    87,
                    12,
                    16,
                    24,
                    36,
                    26,
                    226,
                    131,
                    55,
                    44,
                    52,
                    4,
                    40,
                    99,
                    92,
                    88,
                    38,
                    208,
                    65,
                    180,
                    106,
                    203,
                    223,
                    72,
                    145,
                    55,
                    152,
                    64,
                    201,
                    19,
                    134,
                    80,
                    178,
                    171,
                    222,
                    141,
                    191,
                    27,
                    146,
                    232,
                    99,
                    122,
                    6,
                    128,
                    57,
                    35,
                    88,
                    91,
                    126,
                    200,
                    104,
                    211,
                    161,
                    245,
                    220,
                    29,
                    243,
                    12,
                    120,
                    229,
                    60,
                    142,
                    237,
                    151,
                    250,
                    220,
                    149,
                    112,
                    134,
                    227,
                    0,
                    82,
                    215,
                    58,
                    227,
                    17,
                    136,
                    133,
                    117,
                    74,
                    102,
                    71,
                    193,
                    56,
                ],
                "float32",
            ).reshape((1, 8, 8, 3))
            / 255.0
        )
        source_foreground = (
            np.array(
                [
                    223,
                    26,
                    115,
                    196,
                    209,
                    25,
                    10,
                    28,
                    173,
                    59,
                    227,
                    225,
                    227,
                    88,
                    196,
                    113,
                    226,
                    128,
                    231,
                    211,
                    196,
                    7,
                    81,
                    8,
                    58,
                    15,
                    181,
                    13,
                    233,
                    140,
                    94,
                    173,
                    13,
                    144,
                    182,
                    10,
                    112,
                    201,
                    78,
                    78,
                    3,
                    145,
                    129,
                    179,
                    143,
                    145,
                    117,
                    235,
                    21,
                    17,
                    226,
                    154,
                    178,
                    42,
                    100,
                    80,
                    57,
                    151,
                    47,
                    78,
                    204,
                    32,
                    238,
                    114,
                    143,
                    172,
                    101,
                    209,
                    190,
                    220,
                    16,
                    171,
                    251,
                    224,
                    210,
                    64,
                    74,
                    252,
                    253,
                    135,
                    150,
                    219,
                    59,
                    114,
                    138,
                    193,
                    148,
                    140,
                    225,
                    151,
                    202,
                    142,
                    220,
                    3,
                    122,
                    113,
                    254,
                    142,
                    17,
                    224,
                    69,
                    10,
                    123,
                    90,
                    198,
                    123,
                    27,
                    229,
                    68,
                    57,
                    67,
                    201,
                    179,
                    113,
                    87,
                    127,
                    39,
                    60,
                    251,
                    186,
                    15,
                    199,
                    96,
                    72,
                    154,
                    26,
                    32,
                    216,
                    133,
                    75,
                    54,
                    179,
                    96,
                    196,
                    144,
                    161,
                    240,
                    74,
                    228,
                    153,
                    198,
                    247,
                    132,
                    120,
                    208,
                    118,
                    165,
                    214,
                    182,
                    31,
                    236,
                    107,
                    105,
                    42,
                    71,
                    241,
                    153,
                    109,
                    244,
                    100,
                    178,
                    155,
                    20,
                    42,
                    145,
                    80,
                    146,
                    127,
                    200,
                    225,
                    174,
                    232,
                    104,
                    92,
                    79,
                    31,
                    72,
                    88,
                    143,
                    10,
                    150,
                    123,
                    98,
                    173,
                    78,
                    205,
                    169,
                    3,
                    120,
                    71,
                    184,
                    178,
                ],
                "float32",
            ).reshape((1, 8, 8, 3))
            / 255.0
        )
        source_background = (
            np.array(
                [
                    184,
                    98,
                    81,
                    45,
                    148,
                    178,
                    123,
                    182,
                    153,
                    146,
                    26,
                    70,
                    70,
                    43,
                    36,
                    44,
                    13,
                    240,
                    147,
                    61,
                    132,
                    32,
                    44,
                    192,
                    159,
                    191,
                    126,
                    220,
                    83,
                    216,
                    53,
                    2,
                    156,
                    25,
                    113,
                    122,
                    183,
                    77,
                    139,
                    93,
                    161,
                    4,
                    229,
                    136,
                    98,
                    123,
                    201,
                    86,
                    19,
                    222,
                    64,
                    243,
                    73,
                    144,
                    189,
                    219,
                    162,
                    217,
                    78,
                    126,
                    198,
                    50,
                    81,
                    217,
                    34,
                    30,
                    69,
                    231,
                    58,
                    39,
                    30,
                    219,
                    14,
                    185,
                    101,
                    148,
                    95,
                    42,
                    4,
                    236,
                    160,
                    3,
                    57,
                    10,
                    22,
                    226,
                    42,
                    187,
                    117,
                    166,
                    98,
                    244,
                    245,
                    72,
                    252,
                    209,
                    188,
                    149,
                    239,
                    205,
                    181,
                    201,
                    80,
                    17,
                    4,
                    152,
                    5,
                    180,
                    204,
                    81,
                    111,
                    88,
                    28,
                    143,
                    252,
                    109,
                    77,
                    82,
                    135,
                    115,
                    252,
                    174,
                    218,
                    163,
                    43,
                    248,
                    234,
                    63,
                    180,
                    216,
                    158,
                    101,
                    206,
                    43,
                    51,
                    198,
                    242,
                    171,
                    192,
                    48,
                    143,
                    66,
                    141,
                    186,
                    3,
                    126,
                    122,
                    83,
                    154,
                    207,
                    142,
                    182,
                    151,
                    149,
                    61,
                    117,
                    206,
                    117,
                    55,
                    187,
                    92,
                    150,
                    133,
                    233,
                    54,
                    85,
                    99,
                    39,
                    119,
                    225,
                    100,
                    75,
                    180,
                    224,
                    167,
                    102,
                    247,
                    239,
                    169,
                    68,
                    165,
                    30,
                    26,
                    132,
                    141,
                    203,
                    40,
                    2,
                    216,
                    120,
                    76,
                    88,
                ],
                "float32",
            ).reshape((1, 8, 8, 3))
            / 255.0
        )
        expect_foreground = np.array(
            [
                0.7979672,
                0.1432547,
                0.4149069,
                0.719775,
                0.6726947,
                -0.0354846,
                0.0552061,
                -0.0020751,
                0.697958,
                0.32943,
                0.9892017,
                1.0652814,
                0.697574,
                0.6188506,
                0.8709102,
                0.6086713,
                0.9759338,
                0.442731,
                1.0239707,
                0.6497501,
                0.7622695,
                0.0365418,
                0.365569,
                -0.0103489,
                0.1614557,
                0.0314278,
                0.5717174,
                0.1964151,
                0.5853804,
                0.3802021,
                0.7025301,
                0.2803172,
                0.1663127,
                0.5205422,
                0.6790515,
                0.3255761,
                0.3512286,
                0.8071212,
                0.2975091,
                0.220455,
                -0.0553355,
                0.7941769,
                0.2594944,
                0.3852408,
                0.533302,
                0.5339154,
                0.2509259,
                1.0767968,
                0.4574004,
                -0.1155391,
                1.0845578,
                0.3114316,
                0.9205116,
                0.8227433,
                0.4376994,
                0.0820475,
                0.1402381,
                0.4909152,
                0.3131487,
                0.4252852,
                0.4850424,
                0.6036082,
                0.9819502,
                0.3947508,
                0.5988396,
                0.7615491,
                0.4458157,
                0.270916,
                1.0272992,
                0.9171737,
                0.2582318,
                0.7497378,
                1.0787406,
                0.7708481,
                0.6447968,
                0.402287,
                0.4601692,
                1.18058,
                0.9837732,
                0.5151176,
                0.5968234,
                0.8681372,
                0.234721,
                0.4683095,
                0.3078267,
                0.53538,
                0.4838923,
                0.6132836,
                0.9196873,
                0.505996,
                0.8421845,
                0.5247742,
                0.7291918,
                0.1659599,
                0.1008439,
                0.2854412,
                0.8995843,
                0.5245517,
                0.1171585,
                0.8743215,
                0.2883479,
                0.0393941,
                0.4977646,
                0.3213273,
                0.8915025,
                0.1808878,
                0.5178848,
                0.8141489,
                0.169675,
                0.1355204,
                0.1475791,
                0.7079594,
                0.6783224,
                0.3446266,
                0.3526772,
                0.5143436,
                0.1409185,
                0.1826121,
                0.7110408,
                0.4450838,
                -0.031458,
                0.7416252,
                0.3216297,
                0.2343832,
                0.4353286,
                0.3214553,
                0.2097116,
                0.7423246,
                0.4121479,
                0.3046774,
                0.2756498,
                0.6689005,
                0.3609839,
                0.6531313,
                0.6707818,
                0.2571744,
                0.7920002,
                0.0704976,
                0.7340238,
                0.5509371,
                0.7886564,
                1.0278763,
                0.6040886,
                0.4420244,
                0.9597371,
                0.2289337,
                0.6388521,
                0.9799126,
                0.6259202,
                0.0888789,
                0.6652538,
                0.3816788,
                0.2965078,
                0.0463032,
                0.3210759,
                0.7768514,
                0.4879533,
                0.6268108,
                0.8189419,
                0.3949238,
                0.7050478,
                0.6178118,
                0.3304193,
                -0.0449886,
                0.8347598,
                0.2144068,
                0.5785272,
                0.719356,
                0.4582718,
                0.6504728,
                0.9178152,
                0.9414403,
                0.529422,
                0.4109686,
                0.3111458,
                0.1440058,
                0.2177912,
                0.7804114,
                0.0478351,
                0.2719599,
                0.6547197,
                0.4813204,
                0.6016568,
                0.5203312,
                0.3242419,
                0.7166285,
                0.6999852,
                0.1304369,
                0.3488722,
                0.2349917,
                0.8404208,
                0.4645913,
            ],
            "float32",
        ).reshape((1, 8, 8, 3))
        expect_background = np.array(
            [
                0.1410783,
                0.6974818,
                0.0440699,
                0.0821272,
                0.2966753,
                0.4401798,
                0.5467104,
                0.2634412,
                0.6785898,
                0.6960666,
                0.2266728,
                0.5049349,
                0.0402778,
                0.5015154,
                0.2655542,
                0.6157916,
                0.2910569,
                0.7825796,
                0.7397264,
                -0.0064536,
                0.5088573,
                0.2264582,
                0.704799,
                0.2895579,
                0.4823802,
                0.6904264,
                0.1987816,
                0.9655134,
                0.0934722,
                0.7277676,
                0.2666422,
                -0.0622633,
                0.6320743,
                0.0590514,
                0.412527,
                0.731231,
                0.3900774,
                0.3722714,
                0.5139251,
                0.1868681,
                0.4916872,
                0.4852218,
                0.7882642,
                0.392223,
                0.3720694,
                0.4339672,
                0.4984422,
                0.5536308,
                0.6020857,
                0.614281,
                0.5299036,
                0.9338521,
                0.3007941,
                0.6076523,
                0.7759343,
                0.6820082,
                0.5717267,
                0.6294952,
                0.5877334,
                0.7553342,
                0.5674802,
                0.5133339,
                0.3499069,
                0.6005244,
                0.3155456,
                0.5343994,
                0.2863649,
                0.7318372,
                0.3169653,
                0.2283038,
                0.388321,
                0.9684153,
                0.1433676,
                0.6246987,
                0.2286292,
                0.7467646,
                0.5594467,
                0.3762027,
                -0.003069,
                0.8935125,
                0.6466636,
                0.23062,
                0.3022137,
                0.5385722,
                -0.0263817,
                0.7793476,
                0.1181178,
                0.9606695,
                0.5908952,
                0.3461834,
                0.6036327,
                0.8161874,
                0.3752922,
                0.4096915,
                0.6764134,
                0.6893781,
                0.444154,
                0.4861689,
                1.0906239,
                0.765532,
                0.8756945,
                0.7899016,
                0.3497156,
                -0.00716,
                0.2843157,
                0.5890816,
                0.0291702,
                0.7039354,
                0.6375652,
                0.1702556,
                0.242422,
                0.0733423,
                0.0297817,
                0.2272992,
                1.0259573,
                0.4809284,
                0.262527,
                0.2680139,
                0.251612,
                0.1619422,
                0.3646923,
                0.4146027,
                0.4761352,
                0.607266,
                0.0563378,
                1.1187412,
                0.922201,
                0.2413956,
                0.6999658,
                0.8915613,
                0.8888406,
                0.2567514,
                0.7910461,
                0.043359,
                0.3150511,
                0.7665169,
                0.9450516,
                0.6647442,
                0.6108024,
                0.144675,
                0.5716036,
                0.4236918,
                0.7934772,
                0.649929,
                0.0946351,
                0.3596092,
                0.4737102,
                0.5913006,
                0.4380362,
                0.750006,
                0.1417255,
                0.65322,
                0.4082954,
                0.4623738,
                0.2831342,
                0.2855505,
                0.7267258,
                0.6031519,
                0.1158372,
                0.8338262,
                0.615327,
                0.9502902,
                0.8153564,
                0.6692469,
                0.522043,
                0.15335,
                0.3990688,
                0.554007,
                0.3350434,
                0.7887428,
                0.487213,
                0.3592632,
                0.9562373,
                0.9817708,
                0.6596029,
                0.4786058,
                0.7424431,
                0.9866713,
                0.6045155,
                0.2930876,
                0.7949001,
                0.1153509,
                0.5852664,
                0.1740943,
                0.5928366,
                0.60639,
                0.2077065,
                0.1698659,
                0.6808803,
                0.4476787,
                0.3607204,
                0.2219806,
            ],
            "float32",
        ).reshape((1, 8, 8, 3))
        expect_alpha = np.array(
            [
                -0.0401553,
                0.3066726,
                0.2853359,
                0.5827136,
                0.4120753,
                0.4428326,
                0.274316,
                0.0531723,
                0.2970671,
                0.4173174,
                0.8288964,
                0.2819067,
                0.2745384,
                0.6065691,
                0.8863942,
                0.7558666,
                0.6449873,
                1.0003469,
                0.7487434,
                0.0389717,
                0.7559744,
                0.422061,
                1.0229068,
                0.4098276,
                0.5148233,
                0.5788374,
                0.3051857,
                0.0565048,
                0.5791458,
                0.1155668,
                0.0704798,
                0.8845045,
                0.1347108,
                0.0772008,
                0.4442904,
                1.0049393,
                0.5997292,
                0.0998031,
                0.2182012,
                -0.0139995,
                0.268675,
                0.4267016,
                0.9398764,
                0.0954803,
                0.4451244,
                0.9983096,
                0.4233467,
                0.3329486,
                0.7606482,
                0.4542023,
                0.0833799,
                0.4301415,
                0.495673,
                0.0083366,
                0.5881871,
                0.605058,
                0.8802087,
                0.2385681,
                0.2882582,
                0.9839736,
                0.2768592,
                0.0031301,
                0.5602181,
                0.6700058,
            ],
            "float32",
        ).reshape((1, 8, 8, 1))

        foreground, background, alpha = FBAFusion(inference_only=False)(
            [source_image, source_foreground, source_background, source_alpha]
        )

        self.assertAllClose(foreground, expect_foreground)
        self.assertAllClose(background, expect_background)
        self.assertAllClose(alpha, expect_alpha)

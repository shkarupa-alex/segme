import numpy as np
import tensorflow as tf
from tensorflow.python.keras import keras_parameterized
from ..region_mutual import RegionMutualInformationLoss
from ..region_mutual import region_mutual_information_loss
from ..region_mutual import _map_get_pairs, _log_det_by_cholesky
from ..region_mutual import _rmi_lower_bound


@keras_parameterized.run_all_keras_modes
class TestMapGetPairs(keras_parameterized.TestCase):
    def test_value(self):
        source_target = np.array([
            [[[1.0, 0.0], [0.0, 0.0], [1.0, 0.0], [1.0, 1.0]], [[1.0, 1.0], [0.0, 0.0], [1.0, 1.0], [0.0, 1.0]],
             [[1.0, 0.0], [0.0, 0.0], [1.0, 1.0], [0.0, 1.0]], [[1.0, 0.0], [1.0, 0.0], [0.0, 0.0], [1.0, 0.0]]]])
        source_output = np.array([
            [[[1.0, 0.0], [0.0, 0.0], [1.0, 1.0], [0.0, 0.0]], [[1.0, 0.0], [0.0, 1.0], [1.0, 1.0], [0.0, 0.0]],
             [[1.0, 1.0], [0.0, 0.0], [1.0, 0.0], [1.0, 1.0]], [[1.0, 1.0], [0.0, 0.0], [1.0, 1.0], [1.0, 0.0]]]])
        expected_target = np.array([
            [[[[1.0], [0.0], [1.0]], [[0.0], [0.0], [0.0]], [[0.0], [1.0], [1.0]], [[0.0], [0.0], [1.0]]],
             [[[1.0], [0.0], [1.0]], [[1.0], [0.0], [1.0]], [[0.0], [1.0], [0.0]], [[0.0], [1.0], [1.0]]],
             [[[1.0], [0.0], [1.0]], [[0.0], [0.0], [1.0]], [[0.0], [1.0], [0.0]], [[0.0], [1.0], [1.0]]],
             [[[1.0], [1.0], [0.0]], [[0.0], [0.0], [0.0]], [[1.0], [0.0], [1.0]], [[0.0], [0.0], [0.0]]]]])
        expected_output = np.array([
            [[[[1.0], [0.0], [1.0]], [[0.0], [0.0], [1.0]], [[0.0], [1.0], [0.0]], [[0.0], [1.0], [0.0]]],
             [[[1.0], [0.0], [1.0]], [[0.0], [1.0], [1.0]], [[0.0], [1.0], [0.0]], [[1.0], [1.0], [0.0]]],
             [[[1.0], [0.0], [1.0]], [[1.0], [0.0], [0.0]], [[0.0], [1.0], [1.0]], [[0.0], [0.0], [1.0]]],
             [[[1.0], [0.0], [1.0]], [[1.0], [0.0], [1.0]], [[0.0], [1.0], [1.0]], [[0.0], [1.0], [0.0]]]]])

        result = self.evaluate(_map_get_pairs(source_target, source_output, radius=2))
        self.assertAllClose(expected_target, result[0])
        self.assertAllClose(expected_output, result[1])


@keras_parameterized.run_all_keras_modes
class TestLogDetByCholesky(keras_parameterized.TestCase):
    def test_value(self):
        source = np.random.rand(1, 4, 4)
        source = np.matmul(source, np.transpose(source, axes=[0, 2, 1]))
        _, expected = np.linalg.slogdet(source)
        result = self.evaluate(_log_det_by_cholesky(source))
        self.assertAllClose(result, expected)


@keras_parameterized.run_all_keras_modes
class TestRmiLowerBound(keras_parameterized.TestCase):
    labels3 = np.array([  # (2, 15, 17, 3)
        [[[0.0, 1.0, 0.0], [0.0, 1.0, 0.0], [0.0, 1.0, 0.0], [0.0, 1.0, 0.0], [1.0, 0.0, 0.0], [0.0, 1.0, 0.0],
          [0.0, 0.0, 1.0], [1.0, 0.0, 0.0], [0.0, 1.0, 0.0], [0.0, 1.0, 0.0], [0.0, 0.0, 1.0], [0.0, 0.0, 1.0],
          [0.0, 1.0, 0.0], [0.0, 0.0, 1.0], [0.0, 1.0, 0.0], [0.0, 0.0, 1.0], [1.0, 0.0, 0.0]],
         [[1.0, 0.0, 0.0], [0.0, 1.0, 0.0], [0.0, 0.0, 1.0], [1.0, 0.0, 0.0], [0.0, 0.0, 1.0], [0.0, 1.0, 0.0],
          [1.0, 0.0, 0.0], [0.0, 1.0, 0.0], [1.0, 0.0, 0.0], [1.0, 0.0, 0.0], [0.0, 1.0, 0.0], [1.0, 0.0, 0.0],
          [0.0, 0.0, 1.0], [1.0, 0.0, 0.0], [0.0, 1.0, 0.0], [0.0, 0.0, 1.0], [1.0, 0.0, 0.0]],
         [[0.0, 1.0, 0.0], [1.0, 0.0, 0.0], [0.0, 1.0, 0.0], [0.0, 1.0, 0.0], [1.0, 0.0, 0.0], [0.0, 1.0, 0.0],
          [0.0, 0.0, 1.0], [1.0, 0.0, 0.0], [0.0, 0.0, 1.0], [1.0, 0.0, 0.0], [0.0, 0.0, 1.0], [1.0, 0.0, 0.0],
          [0.0, 1.0, 0.0], [0.0, 1.0, 0.0], [1.0, 0.0, 0.0], [1.0, 0.0, 0.0], [0.0, 0.0, 1.0]],
         [[0.0, 1.0, 0.0], [0.0, 1.0, 0.0], [0.0, 0.0, 1.0], [1.0, 0.0, 0.0], [0.0, 0.0, 1.0], [0.0, 1.0, 0.0],
          [1.0, 0.0, 0.0], [1.0, 0.0, 0.0], [0.0, 0.0, 1.0], [1.0, 0.0, 0.0], [1.0, 0.0, 0.0], [1.0, 0.0, 0.0],
          [1.0, 0.0, 0.0], [0.0, 1.0, 0.0], [0.0, 0.0, 1.0], [1.0, 0.0, 0.0], [0.0, 1.0, 0.0]],
         [[0.0, 1.0, 0.0], [0.0, 1.0, 0.0], [1.0, 0.0, 0.0], [1.0, 0.0, 0.0], [0.0, 0.0, 1.0], [0.0, 0.0, 1.0],
          [0.0, 1.0, 0.0], [0.0, 0.0, 1.0], [0.0, 1.0, 0.0], [1.0, 0.0, 0.0], [1.0, 0.0, 0.0], [0.0, 0.0, 1.0],
          [1.0, 0.0, 0.0], [0.0, 0.0, 1.0], [0.0, 1.0, 0.0], [0.0, 1.0, 0.0], [0.0, 1.0, 0.0]],
         [[0.0, 0.0, 1.0], [0.0, 0.0, 1.0], [0.0, 0.0, 1.0], [0.0, 0.0, 1.0], [1.0, 0.0, 0.0], [1.0, 0.0, 0.0],
          [0.0, 0.0, 1.0], [0.0, 1.0, 0.0], [0.0, 1.0, 0.0], [1.0, 0.0, 0.0], [0.0, 0.0, 1.0], [1.0, 0.0, 0.0],
          [1.0, 0.0, 0.0], [0.0, 1.0, 0.0], [0.0, 0.0, 1.0], [0.0, 0.0, 1.0], [0.0, 1.0, 0.0]],
         [[0.0, 0.0, 1.0], [0.0, 1.0, 0.0], [1.0, 0.0, 0.0], [1.0, 0.0, 0.0], [1.0, 0.0, 0.0], [1.0, 0.0, 0.0],
          [0.0, 0.0, 1.0], [0.0, 1.0, 0.0], [1.0, 0.0, 0.0], [0.0, 0.0, 1.0], [0.0, 1.0, 0.0], [0.0, 1.0, 0.0],
          [0.0, 1.0, 0.0], [0.0, 1.0, 0.0], [0.0, 1.0, 0.0], [0.0, 1.0, 0.0], [0.0, 0.0, 1.0]],
         [[0.0, 0.0, 1.0], [0.0, 0.0, 1.0], [1.0, 0.0, 0.0], [1.0, 0.0, 0.0], [0.0, 0.0, 1.0], [1.0, 0.0, 0.0],
          [0.0, 1.0, 0.0], [0.0, 0.0, 1.0], [1.0, 0.0, 0.0], [0.0, 1.0, 0.0], [0.0, 1.0, 0.0], [0.0, 1.0, 0.0],
          [0.0, 0.0, 1.0], [0.0, 0.0, 1.0], [0.0, 0.0, 1.0], [0.0, 1.0, 0.0], [1.0, 0.0, 0.0]],
         [[0.0, 0.0, 1.0], [0.0, 1.0, 0.0], [1.0, 0.0, 0.0], [0.0, 0.0, 1.0], [0.0, 1.0, 0.0], [0.0, 1.0, 0.0],
          [0.0, 0.0, 1.0], [0.0, 0.0, 1.0], [1.0, 0.0, 0.0], [1.0, 0.0, 0.0], [0.0, 0.0, 1.0], [1.0, 0.0, 0.0],
          [0.0, 1.0, 0.0], [0.0, 0.0, 1.0], [0.0, 0.0, 1.0], [0.0, 0.0, 1.0], [1.0, 0.0, 0.0]],
         [[1.0, 0.0, 0.0], [0.0, 0.0, 1.0], [0.0, 1.0, 0.0], [0.0, 0.0, 1.0], [0.0, 1.0, 0.0], [0.0, 1.0, 0.0],
          [0.0, 0.0, 1.0], [0.0, 0.0, 1.0], [1.0, 0.0, 0.0], [0.0, 1.0, 0.0], [0.0, 1.0, 0.0], [1.0, 0.0, 0.0],
          [0.0, 1.0, 0.0], [0.0, 0.0, 1.0], [0.0, 1.0, 0.0], [1.0, 0.0, 0.0], [0.0, 1.0, 0.0]],
         [[1.0, 0.0, 0.0], [0.0, 1.0, 0.0], [1.0, 0.0, 0.0], [1.0, 0.0, 0.0], [1.0, 0.0, 0.0], [0.0, 0.0, 1.0],
          [0.0, 1.0, 0.0], [0.0, 1.0, 0.0], [0.0, 1.0, 0.0], [1.0, 0.0, 0.0], [1.0, 0.0, 0.0], [0.0, 0.0, 1.0],
          [1.0, 0.0, 0.0], [1.0, 0.0, 0.0], [0.0, 1.0, 0.0], [0.0, 1.0, 0.0], [1.0, 0.0, 0.0]],
         [[0.0, 0.0, 1.0], [1.0, 0.0, 0.0], [1.0, 0.0, 0.0], [0.0, 1.0, 0.0], [0.0, 1.0, 0.0], [0.0, 0.0, 1.0],
          [0.0, 0.0, 1.0], [1.0, 0.0, 0.0], [0.0, 0.0, 1.0], [0.0, 0.0, 1.0], [1.0, 0.0, 0.0], [0.0, 1.0, 0.0],
          [1.0, 0.0, 0.0], [0.0, 1.0, 0.0], [0.0, 0.0, 1.0], [0.0, 0.0, 1.0], [0.0, 1.0, 0.0]],
         [[1.0, 0.0, 0.0], [0.0, 1.0, 0.0], [1.0, 0.0, 0.0], [0.0, 1.0, 0.0], [0.0, 1.0, 0.0], [0.0, 0.0, 1.0],
          [1.0, 0.0, 0.0], [0.0, 1.0, 0.0], [1.0, 0.0, 0.0], [0.0, 1.0, 0.0], [0.0, 0.0, 1.0], [1.0, 0.0, 0.0],
          [0.0, 0.0, 1.0], [1.0, 0.0, 0.0], [0.0, 1.0, 0.0], [1.0, 0.0, 0.0], [0.0, 0.0, 1.0]],
         [[0.0, 0.0, 1.0], [0.0, 0.0, 1.0], [0.0, 0.0, 1.0], [0.0, 1.0, 0.0], [0.0, 1.0, 0.0], [1.0, 0.0, 0.0],
          [1.0, 0.0, 0.0], [1.0, 0.0, 0.0], [0.0, 0.0, 1.0], [1.0, 0.0, 0.0], [0.0, 1.0, 0.0], [0.0, 0.0, 1.0],
          [1.0, 0.0, 0.0], [1.0, 0.0, 0.0], [0.0, 1.0, 0.0], [0.0, 0.0, 1.0], [1.0, 0.0, 0.0]],
         [[1.0, 0.0, 0.0], [1.0, 0.0, 0.0], [0.0, 1.0, 0.0], [0.0, 1.0, 0.0], [1.0, 0.0, 0.0], [0.0, 1.0, 0.0],
          [0.0, 1.0, 0.0], [0.0, 0.0, 1.0], [1.0, 0.0, 0.0], [0.0, 1.0, 0.0], [0.0, 0.0, 1.0], [0.0, 1.0, 0.0],
          [0.0, 1.0, 0.0], [1.0, 0.0, 0.0], [1.0, 0.0, 0.0], [0.0, 0.0, 1.0], [0.0, 0.0, 1.0]]],
        [[[0.0, 1.0, 0.0], [1.0, 0.0, 0.0], [0.0, 1.0, 0.0], [1.0, 0.0, 0.0], [0.0, 1.0, 0.0], [0.0, 1.0, 0.0],
          [0.0, 0.0, 1.0], [0.0, 0.0, 1.0], [0.0, 1.0, 0.0], [0.0, 1.0, 0.0], [1.0, 0.0, 0.0], [0.0, 1.0, 0.0],
          [0.0, 0.0, 1.0], [0.0, 0.0, 1.0], [1.0, 0.0, 0.0], [1.0, 0.0, 0.0], [0.0, 1.0, 0.0]],
         [[0.0, 1.0, 0.0], [0.0, 0.0, 1.0], [0.0, 0.0, 1.0], [0.0, 0.0, 1.0], [1.0, 0.0, 0.0], [0.0, 1.0, 0.0],
          [1.0, 0.0, 0.0], [0.0, 0.0, 1.0], [1.0, 0.0, 0.0], [0.0, 1.0, 0.0], [0.0, 0.0, 1.0], [0.0, 1.0, 0.0],
          [1.0, 0.0, 0.0], [1.0, 0.0, 0.0], [1.0, 0.0, 0.0], [0.0, 0.0, 1.0], [0.0, 1.0, 0.0]],
         [[0.0, 1.0, 0.0], [1.0, 0.0, 0.0], [0.0, 0.0, 1.0], [0.0, 0.0, 1.0], [0.0, 1.0, 0.0], [1.0, 0.0, 0.0],
          [0.0, 1.0, 0.0], [0.0, 0.0, 1.0], [0.0, 0.0, 1.0], [1.0, 0.0, 0.0], [0.0, 1.0, 0.0], [0.0, 1.0, 0.0],
          [0.0, 0.0, 1.0], [1.0, 0.0, 0.0], [0.0, 0.0, 1.0], [0.0, 0.0, 1.0], [0.0, 1.0, 0.0]],
         [[0.0, 1.0, 0.0], [1.0, 0.0, 0.0], [0.0, 0.0, 1.0], [0.0, 1.0, 0.0], [0.0, 0.0, 1.0], [1.0, 0.0, 0.0],
          [0.0, 0.0, 1.0], [1.0, 0.0, 0.0], [0.0, 1.0, 0.0], [1.0, 0.0, 0.0], [0.0, 1.0, 0.0], [1.0, 0.0, 0.0],
          [0.0, 1.0, 0.0], [0.0, 1.0, 0.0], [0.0, 1.0, 0.0], [0.0, 0.0, 1.0], [0.0, 1.0, 0.0]],
         [[1.0, 0.0, 0.0], [0.0, 0.0, 1.0], [0.0, 0.0, 1.0], [0.0, 1.0, 0.0], [0.0, 1.0, 0.0], [1.0, 0.0, 0.0],
          [0.0, 0.0, 1.0], [1.0, 0.0, 0.0], [1.0, 0.0, 0.0], [0.0, 1.0, 0.0], [0.0, 1.0, 0.0], [0.0, 1.0, 0.0],
          [1.0, 0.0, 0.0], [1.0, 0.0, 0.0], [1.0, 0.0, 0.0], [1.0, 0.0, 0.0], [0.0, 1.0, 0.0]],
         [[1.0, 0.0, 0.0], [0.0, 0.0, 1.0], [0.0, 0.0, 1.0], [0.0, 0.0, 1.0], [1.0, 0.0, 0.0], [0.0, 0.0, 1.0],
          [0.0, 0.0, 1.0], [0.0, 1.0, 0.0], [0.0, 1.0, 0.0], [1.0, 0.0, 0.0], [0.0, 1.0, 0.0], [0.0, 1.0, 0.0],
          [1.0, 0.0, 0.0], [0.0, 0.0, 1.0], [0.0, 0.0, 1.0], [0.0, 1.0, 0.0], [1.0, 0.0, 0.0]],
         [[0.0, 1.0, 0.0], [0.0, 1.0, 0.0], [1.0, 0.0, 0.0], [1.0, 0.0, 0.0], [1.0, 0.0, 0.0], [1.0, 0.0, 0.0],
          [0.0, 0.0, 1.0], [0.0, 0.0, 1.0], [1.0, 0.0, 0.0], [0.0, 0.0, 1.0], [0.0, 0.0, 1.0], [0.0, 1.0, 0.0],
          [0.0, 0.0, 1.0], [0.0, 0.0, 1.0], [0.0, 0.0, 1.0], [1.0, 0.0, 0.0], [0.0, 0.0, 1.0]],
         [[0.0, 1.0, 0.0], [0.0, 0.0, 1.0], [0.0, 0.0, 1.0], [0.0, 0.0, 1.0], [1.0, 0.0, 0.0], [1.0, 0.0, 0.0],
          [1.0, 0.0, 0.0], [0.0, 1.0, 0.0], [1.0, 0.0, 0.0], [1.0, 0.0, 0.0], [1.0, 0.0, 0.0], [1.0, 0.0, 0.0],
          [0.0, 0.0, 1.0], [0.0, 1.0, 0.0], [0.0, 1.0, 0.0], [0.0, 0.0, 1.0], [1.0, 0.0, 0.0]],
         [[0.0, 0.0, 1.0], [1.0, 0.0, 0.0], [0.0, 0.0, 1.0], [0.0, 1.0, 0.0], [1.0, 0.0, 0.0], [0.0, 0.0, 1.0],
          [1.0, 0.0, 0.0], [0.0, 0.0, 1.0], [0.0, 1.0, 0.0], [1.0, 0.0, 0.0], [0.0, 0.0, 1.0], [0.0, 0.0, 1.0],
          [1.0, 0.0, 0.0], [0.0, 1.0, 0.0], [0.0, 0.0, 1.0], [0.0, 1.0, 0.0], [1.0, 0.0, 0.0]],
         [[1.0, 0.0, 0.0], [0.0, 0.0, 1.0], [0.0, 1.0, 0.0], [0.0, 0.0, 1.0], [0.0, 0.0, 1.0], [1.0, 0.0, 0.0],
          [1.0, 0.0, 0.0], [0.0, 0.0, 1.0], [0.0, 0.0, 1.0], [0.0, 1.0, 0.0], [1.0, 0.0, 0.0], [1.0, 0.0, 0.0],
          [0.0, 1.0, 0.0], [0.0, 1.0, 0.0], [1.0, 0.0, 0.0], [1.0, 0.0, 0.0], [0.0, 0.0, 1.0]],
         [[1.0, 0.0, 0.0], [1.0, 0.0, 0.0], [0.0, 0.0, 1.0], [1.0, 0.0, 0.0], [0.0, 1.0, 0.0], [0.0, 0.0, 1.0],
          [1.0, 0.0, 0.0], [0.0, 0.0, 1.0], [0.0, 0.0, 1.0], [0.0, 0.0, 1.0], [0.0, 1.0, 0.0], [0.0, 1.0, 0.0],
          [0.0, 0.0, 1.0], [1.0, 0.0, 0.0], [1.0, 0.0, 0.0], [0.0, 1.0, 0.0], [1.0, 0.0, 0.0]],
         [[1.0, 0.0, 0.0], [0.0, 1.0, 0.0], [1.0, 0.0, 0.0], [0.0, 1.0, 0.0], [0.0, 1.0, 0.0], [0.0, 0.0, 1.0],
          [0.0, 0.0, 1.0], [0.0, 1.0, 0.0], [0.0, 1.0, 0.0], [1.0, 0.0, 0.0], [0.0, 0.0, 1.0], [0.0, 0.0, 1.0],
          [0.0, 1.0, 0.0], [1.0, 0.0, 0.0], [0.0, 0.0, 1.0], [0.0, 1.0, 0.0], [1.0, 0.0, 0.0]],
         [[1.0, 0.0, 0.0], [0.0, 1.0, 0.0], [0.0, 0.0, 1.0], [0.0, 1.0, 0.0], [0.0, 1.0, 0.0], [1.0, 0.0, 0.0],
          [0.0, 1.0, 0.0], [1.0, 0.0, 0.0], [0.0, 1.0, 0.0], [0.0, 0.0, 1.0], [0.0, 1.0, 0.0], [0.0, 0.0, 1.0],
          [0.0, 0.0, 1.0], [0.0, 0.0, 1.0], [0.0, 1.0, 0.0], [0.0, 0.0, 1.0], [1.0, 0.0, 0.0]],
         [[0.0, 1.0, 0.0], [0.0, 1.0, 0.0], [0.0, 1.0, 0.0], [0.0, 0.0, 1.0], [0.0, 0.0, 1.0], [1.0, 0.0, 0.0],
          [0.0, 0.0, 1.0], [1.0, 0.0, 0.0], [1.0, 0.0, 0.0], [1.0, 0.0, 0.0], [0.0, 1.0, 0.0], [0.0, 1.0, 0.0],
          [1.0, 0.0, 0.0], [0.0, 1.0, 0.0], [1.0, 0.0, 0.0], [0.0, 1.0, 0.0], [1.0, 0.0, 0.0]],
         [[1.0, 0.0, 0.0], [1.0, 0.0, 0.0], [1.0, 0.0, 0.0], [0.0, 1.0, 0.0], [0.0, 0.0, 1.0], [0.0, 0.0, 1.0],
          [0.0, 0.0, 1.0], [1.0, 0.0, 0.0], [0.0, 0.0, 1.0], [0.0, 0.0, 1.0], [0.0, 0.0, 1.0], [1.0, 0.0, 0.0],
          [1.0, 0.0, 0.0], [1.0, 0.0, 0.0], [0.0, 0.0, 1.0], [0.0, 0.0, 1.0], [0.0, 1.0, 0.0]]]], dtype='float32')
    probs3 = np.array([
        [[[0.549834997312478, 0.9878725650157257, 0.7685257834990176],
          [0.9999508278353162, 0.9998999708060923, 0.9989942291799144],
          [0.8909041788043871, 0.9998646296729204, 0.9977631514787236],
          [0.9241428199787566, 0.5986886601124521, 0.9926094586557181],
          [0.9975283768433654, 0.9999332758503804, 0.9370276439430035],
          [0.9909877013471521, 0.9972690392369891, 0.9998502896419403],
          [0.9996656498695337, 0.9866140821723351, 0.8320193851339245],
          [0.8021848885585817, 0.9945147011005495, 0.9933081490757153],
          [0.9998344419352228, 0.9994482213630764, 0.9983421989198256],
          [0.9990899488055994, 0.9999508278353162, 0.9983421989198256],
          [0.9900491981330958, 0.9996303938593736, 0.9998999708060923],
          [0.9088780389851439, 0.8698925256370021, 0.9998646296729204],
          [0.9525751268224334, 0.52498018747894, 0.9986424800495711],
          [0.549834997312478, 0.7502611055951177, 0.9900491981330958],
          [0.9998502896419403, 0.9998646296729204, 0.9909877013471521],
          [0.9981680610575072, 0.9975283768433654, 0.549834997312478],
          [0.9996303938593736, 0.5986886601124521, 0.8021848885585817]],
         [[0.7310595786300049, 0.9677055353015495, 0.9999508278353162],
          [0.985226968306727, 0.7858359830425586, 0.9900491981330958],
          [0.9999332758503804, 0.9963167601005641, 0.9999508278353162],
          [0.9998169280950366, 0.9939411985084158, 0.7685257834990176],
          [0.9979756796109501, 0.9002505108803148, 0.9989942291799144],
          [0.998499817743263, 0.9866140821723351, 0.9608352772032357],
          [0.7502611055951177, 0.7502611055951177, 0.9997761832297667],
          [0.9608352772032357, 0.9308625796566533, 0.8807980779778823],
          [0.9734040064231341, 0.9994482213630764, 0.9990899488055994],
          [0.9939411985084158, 0.9955047268390589, 0.9677055353015495],
          [0.9370276439430035, 0.995930862284104, 0.9900491981330958],
          [0.9995483777767595, 0.9998344419352228, 0.9963167601005641],
          [0.6681887721681662, 0.9997761832297667, 0.9999182827771484],
          [0.9677055353015495, 0.9933081490757153, 0.9677055353015495],
          [0.5986886601124521, 0.7109505026250039, 0.9999182827771484],
          [0.9933081490757153, 0.9878725650157257, 0.9308625796566533],
          [0.9996303938593736, 0.9568937450589139, 0.9998776054240137]],
         [[0.9955047268390589, 0.9992549711661634, 0.998499817743263],
          [0.9996303938593736, 0.549834997312478, 0.9866140821723351],
          [0.6456573062257954, 0.7109505026250039, 0.9525751268224334],
          [0.9996303938593736, 0.9820147900379085, 0.9955047268390589],
          [0.9981680610575072, 0.9998344419352228, 0.9836985006285591],
          [0.8455357349164653, 0.9969825836752917, 0.9525751268224334],
          [0.9878725650157257, 0.9734040064231341, 0.9995007988929205],
          [0.9998344419352228, 0.9677055353015495, 0.9981680610575072],
          [0.5744435168116591, 0.9933081490757153, 0.9866140821723351],
          [0.9999095841261478, 0.9990899488055994, 0.9966661926925867],
          [0.6224603312018546, 0.995930862284104, 0.9241428199787566],
          [0.9981680610575072, 0.9998893466593705, 0.9992549711661634],
          [0.9781197290638695, 0.9909877013471521, 0.9836985006285591],
          [0.9890140573694068, 0.9996303938593736, 0.9918384288468401],
          [0.9996975529699712, 0.9308625796566533, 0.9002505108803148],
          [0.9997525449181606, 0.6224603312018546, 0.9820147900379085],
          [0.9955047268390589, 0.8581499350995123, 0.9820147900379085]],
         [[0.9995483777767595, 0.9998776054240137, 0.995930862284104],
          [0.9999332758503804, 0.8021848885585817, 0.9999455514752772],
          [0.9998999708060923, 0.9734040064231341, 0.999591432835014],
          [0.8021848885585817, 0.9241428199787566, 0.9781197290638695],
          [0.9979756796109501, 0.9308625796566533, 0.9945147011005495],
          [0.8175754761936437, 0.9608352772032357, 0.8175754761936437],
          [0.9836985006285591, 0.9999508278353162, 0.9939411985084158],
          [0.5744435168116591, 0.9088780389851439, 0.8455357349164653],
          [0.7109505026250039, 0.9878725650157257, 0.9997761832297667],
          [0.9986424800495711, 0.5986886601124521, 0.8455357349164653],
          [0.8021848885585817, 0.9995007988929205, 0.9677055353015495],
          [0.9426768241011313, 0.9966661926925867, 0.9999556021312976],
          [0.9991765753136017, 0.8698925256370021, 0.9781197290638695],
          [0.995034198349943, 0.9998776054240137, 0.7109505026250039],
          [0.9998169280950366, 0.9308625796566533, 0.9478474369215824],
          [0.9997975730219448, 0.9478474369215824, 0.9918384288468401],
          [0.9677055353015495, 0.8455357349164653, 0.9996303938593736]],
         [[0.9866140821723351, 0.500001, 0.9966661926925867],
          [0.9945147011005495, 0.9997264218438986, 0.8698925256370021],
          [0.9996303938593736, 0.6224603312018546, 0.9998893466593705],
          [0.9975283768433654, 0.9997525449181606, 0.6681887721681662],
          [0.9966661926925867, 0.9999261537724895, 0.8455357349164653],
          [0.9999508278353162, 0.9995483777767595, 0.9997264218438986],
          [0.9758739785823308, 0.500001, 0.9995007988929205],
          [0.9677055353015495, 0.9426768241011313, 0.7310595786300049],
          [0.5744435168116591, 0.9677055353015495, 0.9900491981330958],
          [0.9986424800495711, 0.9994482213630764, 0.549834997312478],
          [0.9996975529699712, 0.9781197290638695, 0.9999261537724895],
          [0.9955047268390589, 0.8807980779778823, 0.52498018747894],
          [0.9977631514787236, 0.8455357349164653, 0.9979756796109501],
          [0.8698925256370021, 0.9890140573694068, 0.7502611055951177],
          [0.9989942291799144, 0.9963167601005641, 0.7858359830425586],
          [0.9969825836752917, 0.985226968306727, 0.6899754811276125],
          [0.8581499350995123, 0.9999397202603834, 0.9955047268390589]],
         [[0.9734040064231341, 0.9979756796109501, 0.7310595786300049],
          [0.9997525449181606, 0.9088780389851439, 0.9997264218438986],
          [0.9945147011005495, 0.9568937450589139, 0.9998344419352228],
          [0.9977631514787236, 0.9926094586557181, 0.9992549711661634],
          [0.9969825836752917, 0.9820147900379085, 0.9801606942659226],
          [0.9168283035060777, 0.9972690392369891, 0.8320193851339245],
          [0.9999182827771484, 0.9997975730219448, 0.995930862284104],
          [0.8698925256370021, 0.8909041788043871, 0.9088780389851439],
          [0.5744435168116591, 0.9677055353015495, 0.9993901206405656],
          [0.9909877013471521, 0.9945147011005495, 0.9992549711661634],
          [0.9370276439430035, 0.6681887721681662, 0.9983421989198256],
          [0.9644298107273639, 0.8175754761936437, 0.9996656498695337],
          [0.9945147011005495, 0.9758739785823308, 0.9991765753136017],
          [0.549834997312478, 0.9996303938593736, 0.9981680610575072],
          [0.9999508278353162, 0.9525751268224334, 0.9996303938593736],
          [0.9308625796566533, 0.9990899488055994, 0.8698925256370021],
          [0.9890140573694068, 0.9909877013471521, 0.9992549711661634]],
         [[0.9955047268390589, 0.8021848885585817, 0.52498018747894],
          [0.9878725650157257, 0.999591432835014, 0.6456573062257954],
          [0.9918384288468401, 0.9370276439430035, 0.9997525449181606],
          [0.7502611055951177, 0.9734040064231341, 0.9969825836752917],
          [0.549834997312478, 0.9900491981330958, 0.9677055353015495],
          [0.998499817743263, 0.549834997312478, 0.998499817743263],
          [0.9998169280950366, 0.9088780389851439, 0.500001],
          [0.9918384288468401, 0.9088780389851439, 0.8320193851339245],
          [0.7685257834990176, 0.9478474369215824, 0.6681887721681662],
          [0.9999508278353162, 0.9890140573694068, 0.9241428199787566],
          [0.9866140821723351, 0.9820147900379085, 0.9979756796109501],
          [0.9997525449181606, 0.9088780389851439, 0.9370276439430035],
          [0.9933081490757153, 0.9999261537724895, 0.9998646296729204],
          [0.9995483777767595, 0.8021848885585817, 0.9996656498695337],
          [0.9998999708060923, 0.9979756796109501, 0.9836985006285591],
          [0.9370276439430035, 0.9997975730219448, 0.9977631514787236],
          [0.9997525449181606, 0.9478474369215824, 0.9525751268224334]],
         [[0.9999332758503804, 0.5986886601124521, 0.9998344419352228],
          [0.9979756796109501, 0.5744435168116591, 0.9426768241011313],
          [0.9993901206405656, 0.9986424800495711, 0.9999508278353162],
          [0.9478474369215824, 0.9981680610575072, 0.9939411985084158],
          [0.7109505026250039, 0.6224603312018546, 0.7310595786300049],
          [0.9996975529699712, 0.9997264218438986, 0.5744435168116591],
          [0.9966661926925867, 0.9991765753136017, 0.999591432835014],
          [0.9608352772032357, 0.9997525449181606, 0.9801606942659226],
          [0.9992549711661634, 0.9866140821723351, 0.9972690392369891],
          [0.9999397202603834, 0.9478474369215824, 0.9992549711661634],
          [0.9981680610575072, 0.9996656498695337, 0.9608352772032357],
          [0.9909877013471521, 0.5986886601124521, 0.9998893466593705],
          [0.9926094586557181, 0.998499817743263, 0.985226968306727],
          [0.995930862284104, 0.9997975730219448, 0.999591432835014],
          [0.998499817743263, 0.9939411985084158, 0.9933081490757153],
          [0.6224603312018546, 0.9991765753136017, 0.9758739785823308],
          [0.9993901206405656, 0.7502611055951177, 0.8807980779778823]],
         [[0.52498018747894, 0.8909041788043871, 0.9478474369215824],
          [0.9002505108803148, 0.995930862284104, 0.9990899488055994],
          [0.9972690392369891, 0.9168283035060777, 0.9734040064231341],
          [0.9999095841261478, 0.52498018747894, 0.9706887692486437],
          [0.998499817743263, 0.9987716013787227, 0.9986424800495711],
          [0.9999397202603834, 0.8175754761936437, 0.999591432835014],
          [0.9608352772032357, 0.6456573062257954, 0.9945147011005495],
          [0.5744435168116591, 0.9998344419352228, 0.9995007988929205],
          [0.8698925256370021, 0.8021848885585817, 0.9998502896419403],
          [0.9088780389851439, 0.8909041788043871, 0.8455357349164653],
          [0.9866140821723351, 0.9972690392369891, 0.9986424800495711],
          [0.9999455514752772, 0.9999397202603834, 0.9168283035060777],
          [0.9568937450589139, 0.9926094586557181, 0.9997975730219448],
          [0.995930862284104, 0.9966661926925867, 0.9979756796109501],
          [0.9999455514752772, 0.9933081490757153, 0.9997761832297667],
          [0.9988884639671398, 0.9998646296729204, 0.9999455514752772],
          [0.9972690392369891, 0.9002505108803148, 0.9998776054240137]],
         [[0.9677055353015495, 0.9478474369215824, 0.6456573062257954],
          [0.9568937450589139, 0.9426768241011313, 0.9994482213630764],
          [0.8455357349164653, 0.9644298107273639, 0.9608352772032357],
          [0.9241428199787566, 0.9996975529699712, 0.8175754761936437],
          [0.9890140573694068, 0.9168283035060777, 0.9987716013787227],
          [0.8581499350995123, 0.9998646296729204, 0.549834997312478],
          [0.9933081490757153, 0.9999095841261478, 0.9972690392369891],
          [0.9999556021312976, 0.985226968306727, 0.5744435168116591],
          [0.9933081490757153, 0.9999182827771484, 0.998499817743263],
          [0.7502611055951177, 0.9986424800495711, 0.9998502896419403],
          [0.5986886601124521, 0.9998646296729204, 0.9986424800495711],
          [0.9002505108803148, 0.999591432835014, 0.6681887721681662],
          [0.9998776054240137, 0.9986424800495711, 0.7109505026250039],
          [0.52498018747894, 0.9999397202603834, 0.9890140573694068],
          [0.9926094586557181, 0.9955047268390589, 0.8581499350995123],
          [0.9677055353015495, 0.9998344419352228, 0.998499817743263],
          [0.9866140821723351, 0.9820147900379085, 0.9918384288468401]],
         [[0.549834997312478, 0.9995007988929205, 0.9998344419352228],
          [0.9999556021312976, 0.9820147900379085, 0.9918384288468401],
          [0.9998893466593705, 0.9308625796566533, 0.9608352772032357],
          [0.8909041788043871, 0.6456573062257954, 0.9918384288468401],
          [0.8698925256370021, 0.9933081490757153, 0.999591432835014],
          [0.8698925256370021, 0.9426768241011313, 0.549834997312478],
          [0.9975283768433654, 0.9977631514787236, 0.7685257834990176],
          [0.995034198349943, 0.9999182827771484, 0.9998344419352228],
          [0.9983421989198256, 0.5744435168116591, 0.9426768241011313],
          [0.9998502896419403, 0.9977631514787236, 0.9997525449181606],
          [0.9988884639671398, 0.9998893466593705, 0.5744435168116591],
          [0.9997761832297667, 0.9999261537724895, 0.6899754811276125],
          [0.9999182827771484, 0.9969825836752917, 0.9241428199787566],
          [0.9426768241011313, 0.9945147011005495, 0.9866140821723351],
          [0.7502611055951177, 0.9706887692486437, 0.9890140573694068],
          [0.9977631514787236, 0.9999095841261478, 0.500001],
          [0.9969825836752917, 0.9990899488055994, 0.9998344419352228]],
         [[0.9939411985084158, 0.9995483777767595, 0.9900491981330958],
          [0.8175754761936437, 0.9525751268224334, 0.9998999708060923],
          [0.9996656498695337, 0.52498018747894, 0.9998344419352228],
          [0.9758739785823308, 0.9995007988929205, 0.9999182827771484],
          [0.7685257834990176, 0.7310595786300049, 0.9890140573694068],
          [0.5744435168116591, 0.9525751268224334, 0.9909877013471521],
          [0.9993259172693673, 0.9939411985084158, 0.9734040064231341],
          [0.9998776054240137, 0.9998502896419403, 0.7858359830425586],
          [0.9878725650157257, 0.8455357349164653, 0.9168283035060777],
          [0.9370276439430035, 0.9993901206405656, 0.9998502896419403],
          [0.9900491981330958, 0.9999261537724895, 0.500001],
          [0.8175754761936437, 0.9990899488055994, 0.9999182827771484],
          [0.9801606942659226, 0.8581499350995123, 0.9989942291799144],
          [0.9979756796109501, 0.9969825836752917, 0.999591432835014],
          [0.9998646296729204, 0.8320193851339245, 0.6456573062257954],
          [0.52498018747894, 0.9995007988929205, 0.9992549711661634],
          [0.9999397202603834, 0.9820147900379085, 0.9998999708060923]],
         [[0.9993901206405656, 0.998499817743263, 0.9002505108803148],
          [0.9993259172693673, 0.9995007988929205, 0.9975283768433654],
          [0.998499817743263, 0.9991765753136017, 0.9088780389851439],
          [0.9988884639671398, 0.9918384288468401, 0.9168283035060777],
          [0.6456573062257954, 0.9997525449181606, 0.9644298107273639],
          [0.9999397202603834, 0.8581499350995123, 0.9987716013787227],
          [0.9918384288468401, 0.9426768241011313, 0.9983421989198256],
          [0.9999332758503804, 0.9998893466593705, 0.8021848885585817],
          [0.9998169280950366, 0.5744435168116591, 0.6899754811276125],
          [0.9999261537724895, 0.9939411985084158, 0.9890140573694068],
          [0.9989942291799144, 0.8455357349164653, 0.9990899488055994],
          [0.9975283768433654, 0.9900491981330958, 0.9866140821723351],
          [0.7502611055951177, 0.9999182827771484, 0.9999261537724895],
          [0.8581499350995123, 0.9993901206405656, 0.9781197290638695],
          [0.9995483777767595, 0.9996975529699712, 0.9979756796109501],
          [0.9706887692486437, 0.9734040064231341, 0.9990899488055994],
          [0.9801606942659226, 0.7109505026250039, 0.9993259172693673]],
         [[0.9977631514787236, 0.9644298107273639, 0.9995007988929205],
          [0.9608352772032357, 0.6899754811276125, 0.9996975529699712],
          [0.9996656498695337, 0.9997761832297667, 0.8581499350995123],
          [0.9975283768433654, 0.9706887692486437, 0.9734040064231341],
          [0.8807980779778823, 0.9933081490757153, 0.9995483777767595],
          [0.9933081490757153, 0.9939411985084158, 0.8581499350995123],
          [0.7109505026250039, 0.7502611055951177, 0.9568937450589139],
          [0.9996656498695337, 0.9878725650157257, 0.995930862284104],
          [0.9999182827771484, 0.9426768241011313, 0.9993259172693673],
          [0.8581499350995123, 0.8807980779778823, 0.6681887721681662],
          [0.9836985006285591, 0.9989942291799144, 0.8455357349164653],
          [0.9992549711661634, 0.52498018747894, 0.9918384288468401],
          [0.9998646296729204, 0.9998646296729204, 0.9781197290638695],
          [0.7109505026250039, 0.8021848885585817, 0.9999508278353162],
          [0.9926094586557181, 0.9969825836752917, 0.5986886601124521],
          [0.9836985006285591, 0.9900491981330958, 0.9426768241011313],
          [0.9986424800495711, 0.9999182827771484, 0.9677055353015495]],
         [[0.9998646296729204, 0.9998893466593705, 0.9992549711661634],
          [0.999591432835014, 0.9478474369215824, 0.9972690392369891],
          [0.9963167601005641, 0.6681887721681662, 0.9998502896419403],
          [0.9706887692486437, 0.995034198349943, 0.9999261537724895],
          [0.9836985006285591, 0.995930862284104, 0.9781197290638695],
          [0.9878725650157257, 0.9088780389851439, 0.995930862284104],
          [0.9998646296729204, 0.9926094586557181, 0.9972690392369891],
          [0.9241428199787566, 0.995930862284104, 0.9990899488055994],
          [0.9998169280950366, 0.52498018747894, 0.9866140821723351],
          [0.9979756796109501, 0.9608352772032357, 0.9972690392369891],
          [0.9734040064231341, 0.9998344419352228, 0.9996975529699712],
          [0.9995483777767595, 0.9002505108803148, 0.7310595786300049],
          [0.9168283035060777, 0.9983421989198256, 0.9308625796566533],
          [0.9801606942659226, 0.9999508278353162, 0.9998344419352228],
          [0.9993259172693673, 0.6456573062257954, 0.7109505026250039],
          [0.9997975730219448, 0.9993901206405656, 0.7502611055951177],
          [0.9939411985084158, 0.8909041788043871, 0.9989942291799144]]],
        [[[0.995930862284104, 0.9998344419352228, 0.9989942291799144],
          [0.9909877013471521, 0.7310595786300049, 0.9981680610575072],
          [0.9975283768433654, 0.9981680610575072, 0.9820147900379085],
          [0.8581499350995123, 0.9999455514752772, 0.9939411985084158],
          [0.9988884639671398, 0.9918384288468401, 0.9969825836752917],
          [0.9993901206405656, 0.9981680610575072, 0.9926094586557181],
          [0.9991765753136017, 0.9677055353015495, 0.9996975529699712],
          [0.9999095841261478, 0.9308625796566533, 0.9525751268224334],
          [0.9900491981330958, 0.9998646296729204, 0.998499817743263],
          [0.9981680610575072, 0.9939411985084158, 0.8175754761936437],
          [0.9963167601005641, 0.6899754811276125, 0.9998776054240137],
          [0.8698925256370021, 0.9981680610575072, 0.9999095841261478],
          [0.9981680610575072, 0.9836985006285591, 0.999591432835014],
          [0.9781197290638695, 0.9996975529699712, 0.9992549711661634],
          [0.9990899488055994, 0.9866140821723351, 0.9945147011005495],
          [0.8698925256370021, 0.9999397202603834, 0.9758739785823308],
          [0.9525751268224334, 0.9999397202603834, 0.9989942291799144]],
         [[0.9996975529699712, 0.9994482213630764, 0.9999261537724895],
          [0.9999261537724895, 0.6224603312018546, 0.9998502896419403],
          [0.985226968306727, 0.9999455514752772, 0.9955047268390589],
          [0.6456573062257954, 0.9999182827771484, 0.9999397202603834],
          [0.9168283035060777, 0.9758739785823308, 0.7502611055951177],
          [0.9998169280950366, 0.6456573062257954, 0.7685257834990176],
          [0.9983421989198256, 0.995930862284104, 0.9088780389851439],
          [0.999591432835014, 0.9997264218438986, 0.7685257834990176],
          [0.7685257834990176, 0.9955047268390589, 0.999591432835014],
          [0.9997975730219448, 0.9909877013471521, 0.7310595786300049],
          [0.7109505026250039, 0.9998344419352228, 0.8455357349164653],
          [0.9168283035060777, 0.5986886601124521, 0.5744435168116591],
          [0.9926094586557181, 0.7858359830425586, 0.52498018747894],
          [0.9989942291799144, 0.9525751268224334, 0.999591432835014],
          [0.7502611055951177, 0.9918384288468401, 0.999591432835014],
          [0.9878725650157257, 0.9706887692486437, 0.549834997312478],
          [0.7310595786300049, 0.9945147011005495, 0.9997975730219448]],
         [[0.9979756796109501, 0.5744435168116591, 0.8909041788043871],
          [0.8698925256370021, 0.9966661926925867, 0.9990899488055994],
          [0.8175754761936437, 0.9568937450589139, 0.9998646296729204],
          [0.7858359830425586, 0.9997975730219448, 0.8698925256370021],
          [0.9994482213630764, 0.9801606942659226, 0.9525751268224334],
          [0.9993259172693673, 0.8021848885585817, 0.9999182827771484],
          [0.9969825836752917, 0.8320193851339245, 0.9999095841261478],
          [0.9890140573694068, 0.9945147011005495, 0.9986424800495711],
          [0.9918384288468401, 0.52498018747894, 0.6456573062257954],
          [0.9997525449181606, 0.8698925256370021, 0.7858359830425586],
          [0.5986886601124521, 0.7502611055951177, 0.9989942291799144],
          [0.500001, 0.9758739785823308, 0.9998893466593705],
          [0.9994482213630764, 0.6899754811276125, 0.6456573062257954],
          [0.995034198349943, 0.9939411985084158, 0.9993901206405656],
          [0.7685257834990176, 0.9568937450589139, 0.9241428199787566],
          [0.9998502896419403, 0.9992549711661634, 0.9995007988929205],
          [0.9781197290638695, 0.5986886601124521, 0.9988884639671398]],
         [[0.9995007988929205, 0.8021848885585817, 0.9996975529699712],
          [0.9677055353015495, 0.9996975529699712, 0.8698925256370021],
          [0.995034198349943, 0.9995483777767595, 0.9933081490757153],
          [0.9997975730219448, 0.8909041788043871, 0.9975283768433654],
          [0.8175754761936437, 0.9998776054240137, 0.9999182827771484],
          [0.500001, 0.9983421989198256, 0.8909041788043871],
          [0.9088780389851439, 0.9993259172693673, 0.9890140573694068],
          [0.9900491981330958, 0.549834997312478, 0.9801606942659226],
          [0.9945147011005495, 0.6456573062257954, 0.9002505108803148],
          [0.9002505108803148, 0.9996656498695337, 0.9977631514787236],
          [0.9734040064231341, 0.6899754811276125, 0.9734040064231341],
          [0.7502611055951177, 0.9990899488055994, 0.9608352772032357],
          [0.7858359830425586, 0.5986886601124521, 0.995930862284104],
          [0.6224603312018546, 0.7109505026250039, 0.9998776054240137],
          [0.9866140821723351, 0.7502611055951177, 0.9988884639671398],
          [0.9426768241011313, 0.8455357349164653, 0.9996656498695337],
          [0.9955047268390589, 0.9945147011005495, 0.9308625796566533]],
         [[0.9955047268390589, 0.9998776054240137, 0.9979756796109501],
          [0.5744435168116591, 0.9890140573694068, 0.9998344419352228],
          [0.9977631514787236, 0.9977631514787236, 0.6899754811276125],
          [0.8175754761936437, 0.9994482213630764, 0.8021848885585817],
          [0.7310595786300049, 0.9890140573694068, 0.9963167601005641],
          [0.9478474369215824, 0.995930862284104, 0.9909877013471521],
          [0.9088780389851439, 0.9758739785823308, 0.9758739785823308],
          [0.9993901206405656, 0.9996656498695337, 0.6681887721681662],
          [0.9989942291799144, 0.9997264218438986, 0.999591432835014],
          [0.9993259172693673, 0.8320193851339245, 0.8698925256370021],
          [0.9999455514752772, 0.9644298107273639, 0.9995007988929205],
          [0.9981680610575072, 0.9866140821723351, 0.9996656498695337],
          [0.9945147011005495, 0.9999261537724895, 0.9939411985084158],
          [0.9997761832297667, 0.999591432835014, 0.7310595786300049],
          [0.7858359830425586, 0.8021848885585817, 0.9997525449181606],
          [0.9918384288468401, 0.995034198349943, 0.9734040064231341],
          [0.7109505026250039, 0.9002505108803148, 0.9975283768433654]],
         [[0.9969825836752917, 0.9983421989198256, 0.9997525449181606],
          [0.7109505026250039, 0.9878725650157257, 0.9890140573694068],
          [0.9999261537724895, 0.9608352772032357, 0.9999397202603834],
          [0.9878725650157257, 0.52498018747894, 0.9758739785823308],
          [0.9979756796109501, 0.9478474369215824, 0.9997975730219448],
          [0.9986424800495711, 0.9999332758503804, 0.9997264218438986],
          [0.9801606942659226, 0.9999095841261478, 0.8175754761936437],
          [0.9241428199787566, 0.9998502896419403, 0.9995483777767595],
          [0.9308625796566533, 0.9939411985084158, 0.9997761832297667],
          [0.8909041788043871, 0.9525751268224334, 0.9996656498695337],
          [0.9820147900379085, 0.9801606942659226, 0.9945147011005495],
          [0.9999261537724895, 0.9370276439430035, 0.9996656498695337],
          [0.9998646296729204, 0.9939411985084158, 0.52498018747894],
          [0.9987716013787227, 0.9608352772032357, 0.5744435168116591],
          [0.52498018747894, 0.9933081490757153, 0.9758739785823308],
          [0.9478474369215824, 0.8807980779778823, 0.6224603312018546],
          [0.9568937450589139, 0.9986424800495711, 0.9998893466593705]],
         [[0.9988884639671398, 0.9986424800495711, 0.9002505108803148],
          [0.9999095841261478, 0.7685257834990176, 0.999591432835014],
          [0.9997761832297667, 0.9992549711661634, 0.9781197290638695],
          [0.9998893466593705, 0.7858359830425586, 0.9002505108803148],
          [0.8698925256370021, 0.9918384288468401, 0.995930862284104],
          [0.9644298107273639, 0.995034198349943, 0.9994482213630764],
          [0.6899754811276125, 0.6681887721681662, 0.9999455514752772],
          [0.7310595786300049, 0.9998169280950366, 0.9998344419352228],
          [0.9979756796109501, 0.8807980779778823, 0.9426768241011313],
          [0.9608352772032357, 0.9878725650157257, 0.8807980779778823],
          [0.7858359830425586, 0.9999095841261478, 0.9706887692486437],
          [0.9734040064231341, 0.9836985006285591, 0.9990899488055994],
          [0.7685257834990176, 0.9997525449181606, 0.9999332758503804],
          [0.9975283768433654, 0.6456573062257954, 0.9478474369215824],
          [0.9997975730219448, 0.52498018747894, 0.9909877013471521],
          [0.8698925256370021, 0.998499817743263, 0.6224603312018546],
          [0.8021848885585817, 0.9918384288468401, 0.9525751268224334]],
         [[0.9997975730219448, 0.9989942291799144, 0.9979756796109501],
          [0.9983421989198256, 0.5744435168116591, 0.9998776054240137],
          [0.9999261537724895, 0.9525751268224334, 0.9525751268224334],
          [0.9999397202603834, 0.9900491981330958, 0.9972690392369891],
          [0.9994482213630764, 0.9370276439430035, 0.9939411985084158],
          [0.9992549711661634, 0.9734040064231341, 0.7858359830425586],
          [0.9706887692486437, 0.9989942291799144, 0.6899754811276125],
          [0.9900491981330958, 0.9820147900379085, 0.549834997312478],
          [0.8320193851339245, 0.9758739785823308, 0.9996656498695337],
          [0.9996656498695337, 0.8455357349164653, 0.9525751268224334],
          [0.9963167601005641, 0.9088780389851439, 0.9900491981330958],
          [0.8807980779778823, 0.9975283768433654, 0.9998646296729204],
          [0.9998344419352228, 0.9801606942659226, 0.9998646296729204],
          [0.9999095841261478, 0.8581499350995123, 0.7109505026250039],
          [0.9979756796109501, 0.9998169280950366, 0.8698925256370021],
          [0.9998502896419403, 0.9999455514752772, 0.9977631514787236],
          [0.9002505108803148, 0.9981680610575072, 0.6681887721681662]],
         [[0.9909877013471521, 0.7685257834990176, 0.9986424800495711],
          [0.9241428199787566, 0.9990899488055994, 0.9983421989198256],
          [0.9993901206405656, 0.9168283035060777, 0.9088780389851439],
          [0.9370276439430035, 0.5986886601124521, 0.9677055353015495],
          [0.9926094586557181, 0.5986886601124521, 0.9999095841261478],
          [0.9997525449181606, 0.8909041788043871, 0.9677055353015495],
          [0.9963167601005641, 0.549834997312478, 0.9988884639671398],
          [0.8021848885585817, 0.9994482213630764, 0.9999261537724895],
          [0.6224603312018546, 0.8455357349164653, 0.9996656498695337],
          [0.52498018747894, 0.549834997312478, 0.9997975730219448],
          [0.8807980779778823, 0.9993259172693673, 0.9890140573694068],
          [0.9969825836752917, 0.9801606942659226, 0.9608352772032357],
          [0.9991765753136017, 0.9999508278353162, 0.9945147011005495],
          [0.9998999708060923, 0.9926094586557181, 0.9999095841261478],
          [0.9644298107273639, 0.9993259172693673, 0.9998776054240137],
          [0.6224603312018546, 0.9734040064231341, 0.9998999708060923],
          [0.9241428199787566, 0.9820147900379085, 0.9677055353015495]],
         [[0.999591432835014, 0.998499817743263, 0.7685257834990176],
          [0.9998169280950366, 0.9987716013787227, 0.9972690392369891],
          [0.8320193851339245, 0.9878725650157257, 0.9997975730219448],
          [0.9999261537724895, 0.9890140573694068, 0.9918384288468401],
          [0.9836985006285591, 0.6681887721681662, 0.9644298107273639],
          [0.7685257834990176, 0.9308625796566533, 0.9996656498695337],
          [0.8175754761936437, 0.9993259172693673, 0.9996975529699712],
          [0.9999182827771484, 0.9999332758503804, 0.9706887692486437],
          [0.9983421989198256, 0.9002505108803148, 0.8320193851339245],
          [0.9426768241011313, 0.998499817743263, 0.7310595786300049],
          [0.9909877013471521, 0.9568937450589139, 0.9983421989198256],
          [0.999591432835014, 0.9820147900379085, 0.52498018747894],
          [0.9644298107273639, 0.9999397202603834, 0.8581499350995123],
          [0.9977631514787236, 0.9996656498695337, 0.9308625796566533],
          [0.7858359830425586, 0.9308625796566533, 0.9781197290638695],
          [0.9969825836752917, 0.9995483777767595, 0.9999332758503804],
          [0.9945147011005495, 0.8807980779778823, 0.6899754811276125]],
         [[0.9909877013471521, 0.6224603312018546, 0.9644298107273639],
          [0.9999182827771484, 0.9993901206405656, 0.7685257834990176],
          [0.9002505108803148, 0.9836985006285591, 0.9801606942659226],
          [0.9644298107273639, 0.9999508278353162, 0.9168283035060777],
          [0.9979756796109501, 0.9997264218438986, 0.9963167601005641],
          [0.9900491981330958, 0.9996303938593736, 0.9781197290638695],
          [0.9370276439430035, 0.9241428199787566, 0.9781197290638695],
          [0.9525751268224334, 0.549834997312478, 0.9734040064231341],
          [0.9997761832297667, 0.9998344419352228, 0.9988884639671398],
          [0.9955047268390589, 0.6456573062257954, 0.9999455514752772],
          [0.9975283768433654, 0.9820147900379085, 0.9979756796109501],
          [0.8455357349164653, 0.9706887692486437, 0.999591432835014],
          [0.9999182827771484, 0.9995483777767595, 0.9997975730219448],
          [0.9972690392369891, 0.9933081490757153, 0.9878725650157257],
          [0.9996303938593736, 0.9998893466593705, 0.9426768241011313],
          [0.9989942291799144, 0.7858359830425586, 0.9568937450589139],
          [0.5986886601124521, 0.9998776054240137, 0.9998169280950366]],
         [[0.9426768241011313, 0.9999455514752772, 0.9969825836752917],
          [0.995930862284104, 0.9878725650157257, 0.9995483777767595],
          [0.9608352772032357, 0.6681887721681662, 0.9836985006285591],
          [0.9706887692486437, 0.9996975529699712, 0.9997761832297667],
          [0.5986886601124521, 0.998499817743263, 0.9308625796566533],
          [0.500001, 0.9969825836752917, 0.6681887721681662],
          [0.9993259172693673, 0.9878725650157257, 0.8455357349164653],
          [0.9568937450589139, 0.9168283035060777, 0.9996303938593736],
          [0.9992549711661634, 0.9996656498695337, 0.9801606942659226],
          [0.6899754811276125, 0.995034198349943, 0.7310595786300049],
          [0.9972690392369891, 0.9979756796109501, 0.9002505108803148],
          [0.6456573062257954, 0.9933081490757153, 0.9998169280950366],
          [0.9878725650157257, 0.549834997312478, 0.9955047268390589],
          [0.549834997312478, 0.9972690392369891, 0.9972690392369891],
          [0.9999182827771484, 0.9525751268224334, 0.9933081490757153],
          [0.8455357349164653, 0.9975283768433654, 0.9979756796109501],
          [0.7310595786300049, 0.9308625796566533, 0.9820147900379085]],
         [[0.9999332758503804, 0.9995007988929205, 0.9999508278353162],
          [0.9996975529699712, 0.9758739785823308, 0.9998776054240137],
          [0.9820147900379085, 0.9478474369215824, 0.9989942291799144],
          [0.9969825836752917, 0.9998776054240137, 0.9918384288468401],
          [0.7109505026250039, 0.9878725650157257, 0.9734040064231341],
          [0.9999455514752772, 0.9989942291799144, 0.500001],
          [0.9998646296729204, 0.9987716013787227, 0.998499817743263],
          [0.9999508278353162, 0.9998776054240137, 0.8021848885585817],
          [0.9644298107273639, 0.9996975529699712, 0.9998502896419403],
          [0.7502611055951177, 0.9998502896419403, 0.9977631514787236],
          [0.7109505026250039, 0.985226968306727, 0.7858359830425586],
          [0.9972690392369891, 0.7109505026250039, 0.995034198349943],
          [0.7310595786300049, 0.8807980779778823, 0.9997525449181606],
          [0.9998502896419403, 0.9370276439430035, 0.9992549711661634],
          [0.8909041788043871, 0.9900491981330958, 0.9955047268390589],
          [0.9963167601005641, 0.9999397202603834, 0.9998893466593705],
          [0.8455357349164653, 0.8581499350995123, 0.7502611055951177]],
         [[0.500001, 0.9998776054240137, 0.9706887692486437],
          [0.9998893466593705, 0.9975283768433654, 0.7502611055951177],
          [0.9987716013787227, 0.9168283035060777, 0.9706887692486437],
          [0.9939411985084158, 0.9998502896419403, 0.9677055353015495],
          [0.6456573062257954, 0.7858359830425586, 0.9998999708060923],
          [0.9677055353015495, 0.9999455514752772, 0.9994482213630764],
          [0.6456573062257954, 0.52498018747894, 0.9998646296729204],
          [0.9986424800495711, 0.9992549711661634, 0.9998169280950366],
          [0.6681887721681662, 0.7109505026250039, 0.9568937450589139],
          [0.9758739785823308, 0.9998893466593705, 0.999591432835014],
          [0.9926094586557181, 0.9981680610575072, 0.8320193851339245],
          [0.9998893466593705, 0.9998344419352228, 0.8021848885585817],
          [0.9983421989198256, 0.9996975529699712, 0.9568937450589139],
          [0.7109505026250039, 0.9977631514787236, 0.9241428199787566],
          [0.9997525449181606, 0.6899754811276125, 0.9866140821723351],
          [0.999591432835014, 0.9999397202603834, 0.8698925256370021],
          [0.9998169280950366, 0.8698925256370021, 0.9426768241011313]],
         [[0.9997761832297667, 0.9933081490757153, 0.9999332758503804],
          [0.5744435168116591, 0.9983421989198256, 0.9644298107273639],
          [0.9966661926925867, 0.8909041788043871, 0.9909877013471521],
          [0.9969825836752917, 0.9975283768433654, 0.9426768241011313],
          [0.9820147900379085, 0.9878725650157257, 0.9993901206405656],
          [0.549834997312478, 0.549834997312478, 0.9998502896419403],
          [0.9979756796109501, 0.7502611055951177, 0.9963167601005641],
          [0.9987716013787227, 0.9996303938593736, 0.9939411985084158],
          [0.9997525449181606, 0.7685257834990176, 0.995034198349943],
          [0.52498018747894, 0.8021848885585817, 0.8021848885585817],
          [0.9998502896419403, 0.9706887692486437, 0.9979756796109501],
          [0.9996656498695337, 0.9999182827771484, 0.9939411985084158],
          [0.500001, 0.9969825836752917, 0.9999095841261478],
          [0.9966661926925867, 0.9999455514752772, 0.9608352772032357],
          [0.9088780389851439, 0.52498018747894, 0.9999455514752772],
          [0.9998893466593705, 0.9998776054240137, 0.8021848885585817],
          [0.5744435168116591, 0.9999556021312976, 0.9644298107273639]]]], dtype='float32')

    def test_value_maxpool_3(self):
        result = _rmi_lower_bound(
            self.labels3, self.probs3, pool_stride=4, pool_way='maxpool', rmi_radius=3)
        result = self.evaluate(result)
        self.assertAlmostEqual(np.sum(result).item(), -11.195279121398926, places=4)

    def test_value_avgpool_3(self):
        result = _rmi_lower_bound(
            self.labels3, self.probs3, pool_stride=4, pool_way='avgpool', rmi_radius=3)
        result = self.evaluate(result)
        self.assertAlmostEqual(np.sum(result).item(), -9.124303817749023, places=5)

    def test_value_resize_3(self):
        result = _rmi_lower_bound(
            self.labels3, self.probs3, pool_stride=4, pool_way='resize', rmi_radius=3)
        result = self.evaluate(result)
        self.assertAlmostEqual(np.sum(result).item(), -10.977413177490234, places=3)


def _to_logit(prob):
    logit = np.log(prob / (1.0 - prob))

    return logit


@keras_parameterized.run_all_keras_modes
class TestRegionMutualInformationLoss(keras_parameterized.TestCase):
    def test_config(self):
        bce_obj = RegionMutualInformationLoss(
            reduction=tf.keras.losses.Reduction.NONE,
            name='loss1'
        )
        self.assertEqual(bce_obj.name, 'loss1')
        self.assertEqual(bce_obj.reduction, tf.keras.losses.Reduction.NONE)

    def test_zeros(self):
        probs = tf.constant([[
            [[0.0], [0.0], [0.0]],
            [[0.0], [0.0], [0.0]],
            [[0.0], [0.0], [0.0]],
        ]], 'float32')
        targets = tf.constant([[
            [[0], [0], [0]],
            [[0], [0], [0]],
            [[0], [0], [0]],
        ]], 'int32')

        result = region_mutual_information_loss(y_true=targets, y_pred=probs)
        result = self.evaluate(result).item()

        self.assertAlmostEqual(result, -3.800450563430786, places=5)

    def test_value_4d(self):
        logits = tf.constant([
            [[[0.4250706654827763], [7.219920928747051], [7.14131948950217], [2.5576064452206024]],
             [[1.342442193620409], [0.20020616879804165], [3.977300484664198], [6.280817910206608]],
             [[0.3206719246447576], [3.0176225602425912], [2.902292891065069], [3.369106587128292]],
             [[2.6576544216404563], [6.863726154333165], [4.581314280496405], [7.433728759092233]]],
            [[[8.13888654097292], [8.311411218599392], [0.8372454481780323], [2.859455217953778]],
             [[2.0984725413538854], [4.619268334888168], [8.708732477440673], [1.9102341271004541]],
             [[3.4914178176388266], [4.551627675234152], [7.709902261544302], [3.3982255596983277]],
             [[0.9182162683255968], [3.0387004793287886], [2.1883984916630697], [1.3921544038795197]]]], 'float32')
        targets = tf.constant([
            [[[0], [0], [1], [0]], [[1], [0], [1], [1]], [[0], [1], [0], [1]], [[0], [1], [1], [1]]],
            [[[0], [1], [1], [0]], [[1], [0], [0], [1]], [[0], [1], [1], [0]], [[1], [1], [1], [1]]]], 'int32')

        loss = RegionMutualInformationLoss(from_logits=True, reduction=tf.keras.losses.Reduction.SUM)
        result = self.evaluate(loss(targets, logits)).item()

        self.assertAlmostEqual(result, -3.8004467487335205, places=5)

    def test_logits(self):
        logits = tf.constant([[
            [[_to_logit(0.03)], [_to_logit(0.55)], [_to_logit(0.85)]],
            [[_to_logit(0.45)], [_to_logit(0.65)], [_to_logit(0.91)]],
            [[_to_logit(0.49)], [_to_logit(0.75)], [_to_logit(0.97)]],
        ]], 'float32')
        targets = tf.constant([[
            [[0], [0], [1]],
            [[0], [1], [1]],
            [[1], [1], [1]],
        ]], 'int32')
        result = region_mutual_information_loss(
            y_true=targets, y_pred=logits, rmi_radius=1, pool_stride=2, pool_way='avgpool', from_logits=True)
        result = self.evaluate(result).item()

        self.assertAlmostEqual(result, -0.9504930973052979, places=6)

    def test_probs(self):
        probs = tf.constant([[
            [[0.03], [0.55], [0.85]],
            [[0.45], [0.65], [0.91]],
            [[0.49], [0.75], [0.97]],
        ]], 'float32')
        targets = tf.constant([[
            [[0], [0], [1]],
            [[0], [1], [1]],
            [[1], [1], [1]],
        ]], 'int32')

        result = region_mutual_information_loss(
            y_true=targets, y_pred=probs, rmi_radius=1, pool_stride=2, pool_way='avgpool')
        result = self.evaluate(result).item()

        self.assertAlmostEqual(result, -0.9504928588867188, places=6)

    def test_keras_model_compile(self):
        model = tf.keras.models.Sequential([
            tf.keras.layers.Input(shape=(100,)),
            tf.keras.layers.Dense(5, activation='sigmoid')]
        )
        model.compile(loss='SegMe>region_mutual_information_loss')


if __name__ == '__main__':
    tf.test.main()
